---
params:
  country: "Thailand"
title: 'PREDICT M&A Report: `r params$country`'
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(CoordinateCleaner)
library(countrycode)
library(DT)
library(eidith)
library(glue)
library(iNEXT)
library(kableExtra)
library(leaflet)
library(leaflet.extras)
library(raster)
library(RColorBrewer)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(tidyverse)
library(wesanderson)
h <- here::here
walk(list.files(h("R/"), full.names = TRUE),
     source, echo = FALSE, verbose = FALSE)
country <- params$country
```

![](./media/predict-logos.png){width="100%"}

#### _Click on the_ ▶ _︎arrows to expand sections._

```{r read-data, include = FALSE}

# Load EIDITH data tables

e <- ed_events() %>% 
  filter(country == !!params$country) # events filtered to country
a <- ed_animals()
s <- ed_specimens()
t <- ed_tests()
v <- ed_viruses()
ts <- ed_testspecimen()

e2 <- ed2_events() %>%
  mutate(country = ifelse(country %in% c("Malaysia, Peninsular", "Malaysia, Sabah"), "Malaysia", country)) %>%
  filter(country == !!params$country) %>% # events filtered to country
  arrange(desc(integer_id)) %>%
  distinct(event_name, .keep_all = TRUE)
a2 <- ed2_animals() %>% 
  select(-c(integer_id, gains4_event_id, gains4_sample_unit_id))
s2 <- ed2_specimens() %>% 
  select(-c(integer_id, gains4_sample_unit_id))
t2 <- ed2_tests() %>%
  select(-c(integer_id))
ti <- ed2_test_interpreted() %>%
  arrange(desc(integer_id)) %>%
  distinct(gains4_test_id, .keep_all = TRUE) %>%
  select(
    -c(integer_id, is_outbreak_testing, season,
       lab_name, real_time_positive_control_value_1, real_time_positive_control_value_2,
       real_time_internal_control_value, real_time_ct_value, lab_name_confirmation,
       test_status, date_govt_approved_release)
  )

# Modify animal taxonomy information

a2 <- a2 %>%
  mutate(
    class = stringr::str_to_sentence(class),
    order = stringr::str_to_sentence(order),
    family = stringr::str_to_sentence(family),
    taxa_group_mod = case_when(
      taxa_group == "cats" ~ "carnivores",
      taxa_group == "dogs" ~ "carnivores",
      taxa_group == "poultry/other fowl" ~ "birds",
      family == "Sciuridae" ~ "rodents/shrews",
      TRUE ~ taxa_group
    ),
    species_scientific_name = case_when(
      species_scientific_name == "Syncerus Caffer" ~ "Syncerus caffer",
      TRUE ~ species_scientific_name
    )
  )

# Split out P2 viral co-infection data

t2 <- t2 %>%
  mutate(
    sequence = case_when(
      str_detect(sequence, "\\|") & !(str_detect(virus, "\\|")) ~ 
        str_replace(sequence, "\\|", ";"),
      str_detect(sequence, "\\|") & is.na(virus) ~ 
        str_replace(sequence, "\\|", ";"),
      TRUE ~ sequence
    )
  )

t2 <- separate_rows(t2, virus, sequence, sep = "\\|")

# Modify virus name (in new "viral_species" column) and detection data

v <- v %>%
  mutate(viral_species = stringi::stri_replace_first_regex(
    virus_name, "(new\\s)?strain\\sof\\s", ""))

t2 <- t2 %>%
  mutate(
    virus = case_when(
      virus == "" ~ NA_character_,
      TRUE ~ virus
    ),
    viral_species = stringi::stri_replace_first_regex(virus, "(new\\s)?strain\\sof\\s", ""),
    viral_species = ifelse(str_detect(viral_species, "(OC43)"), "Betacoronavirus 1 (OC43)", viral_species),
    viral_species = ifelse(str_detect(viral_species, "MJ/67C"), "Hipposideros bat alphacoronavirus MJ/67C", viral_species),
    viral_species = ifelse(str_detect(viral_species, "(PPR)"), "Peste des petits ruminants (PPR)", viral_species),
    viral_species = ifelse(viral_species == "Human Coronavirus 229E (Human strain)", "Coronavirus 229E (Human strain)", viral_species),
    viral_species = str_replace(viral_species, "Bat Coronavirus", "Bat coronavirus"),
    viral_species = str_replace(viral_species, " Bat ", " bat "),
    virus_detected = ifelse(confirmation_result == "Positive", 1, 0)
  ) %>%
  left_join(., read_csv(h("data", "viral_species_modifications.csv")), by = "viral_species") %>%
  mutate(viral_species = ifelse(!is.na(viral_species_mod), viral_species_mod, viral_species)) %>%
  select(-viral_species_mod)

# Join across all tables to get complete data

d <- left_join(e, a, by = "event_id") %>%
  left_join(s, by = "animal_id") %>%
  left_join(ts, by = "specimen_id") %>%
  left_join(t, by = "test_id") %>%
  left_join(v, by = "test_id")

d2 <- left_join(e2, a2, by = c("event_name", "project")) %>%
  left_join(s2, by = c("animal_id" = "animal_human_id", "project")) %>%
  left_join(t2, by = c("specimen_id", "gains4_specimen_id", "project")) %>%
  left_join(ti, by = c("gains4_specimen_id", "gains4_test_id", "project"))
```

### Section 1: Summary of Viral Findings

<details>
<summary><font size="+1.5"><b>Virus-Level Summary Table</b></font></summary>

This table provides an overview of all in-country viral findings. For each unique virus detected, the table indicates the number of detections, the host taxa in which these detections occurred, and the associated sites. Finally, to add broader context to viral findings, the final column of the table lists other PREDICT-2 countries in which the same virus was found, highlighting the potential geographic range of the pathogen.

```{r tables-1}

animal.grouping.vars <-
  c("country", "concurrent_sampling_site", "site_name",
    "human_density_impact", "taxa_group_mod", 
    "species_scientific_name", "test_requested", "viral_species")

animal_virus_summary <- d2 %>%
  filter(!is.na(viral_species)) %>%
  mutate(
    species_scientific_name = case_when(
      str_detect(species_scientific_name, " cf. ") ~ 
        str_replace(species_scientific_name, " cf. ", " "),
      TRUE ~ species_scientific_name
    )
  ) %>%
  group_by_at(vars(one_of(animal.grouping.vars))) %>%
  summarize(n_positives = sum(virus_detected)) %>%
  ungroup() %>%
  arrange(country, site_name, taxa_group_mod, 
          species_scientific_name, viral_species, n_positives)

text.color <- "#787272"

get_country_viruses(view = FALSE, animal_virus_summary) %>%
  left_join(., read_csv(h("data", "viral_species_country_lookup.csv")), 
            by = c(`Virus Name` = "viral_species")) %>%
  mutate(country = ifelse(country == params$country, NA_character_, country)) %>%
  group_by_at(vars(-country)) %>%
  summarize("Concurrent Detections" = paste(unique(country), collapse = "\n")) %>%
  ungroup() %>%
  mutate(
    `Concurrent Detections` = str_replace(`Concurrent Detections`, "NA\n", ""),
    `Concurrent Detections` = str_replace(`Concurrent Detections`, "\nNA", "")
  ) %>%
  arrange(`Viral Test Type`, `Virus Name`) %>%
  mutate_all(
    cell_spec, format = "html", 
    bold = TRUE, color = text.color
  ) %>%
  kable(escape = FALSE, align = "c") %>%
  kable_styling(fixed_thead = TRUE)
```
</details>

<details>
<summary><font size="+1.5"><b>Viral Testing Heatmap</b></font></summary>

Building from the viral summary table above, this heatmap provides more granular information about sampling effort and detection rates across the five priority PREDICT-2 viral groups: Coronaviruses, Filoviruses, Flaviviruses, Influenzas, and Paramyxoviruses. Data shown within the heatmap represent numbers of viral PCR tests. Host taxa sampled are summarized to the genus-level, and taxa groups are indicated in parentheses. The intensity of red color within the heatmap scales with viral detection rate. Host taxa that never yielded positive viral tests for a given viral group are shown in white, while red coloration indicates increasingly higher rates of viral detection.

```{r heatmap, fig.align = "center", fig.width = 10}

# Plot country-level heat maps of viral detections in specimens

tests.of.interest <- c("Coronaviruses", "Filoviruses", "Flaviviruses",
                       "Influenzas", "Paramyxoviruses")

tmp <- d2 %>%
  mutate(
    family = case_when(
      is.na(family) ~ "Unknown",
      TRUE ~ family
    ),
    genus = case_when(
      is.na(genus) ~ "Unknown",
      TRUE ~ genus
    )
  ) %>%
  filter(
    test_requested %in% tests.of.interest,
    test_type == "Conventional PCR"
  ) %>%
  arrange(gains4_test_id, desc(virus_detected)) %>%
  distinct(gains4_test_id, .keep_all = TRUE) %>%
  group_by(taxa_group_mod, genus, test_requested) %>%
  summarize(
    n_tests = n_distinct(gains4_test_id),
    n_positives = sum(virus_detected, na.rm = TRUE),
    prop = n_positives/n_tests,
    prop.num.for.plot = ifelse(prop == 0, prop, prop + 0.1),
    percent = round(n_positives/n_tests*100, digits = 1),
    percent_mod = paste0(percent, "% (", n_tests, ")")
  ) %>%
  ungroup() %>%
  filter(
    !is.na(taxa_group_mod),
    !is.na(test_requested)
  ) %>%
  arrange(taxa_group_mod, genus) %>%
  mutate(
    genus = paste0(genus, " (", taxa_group_mod, ")"),
    genus = factor(genus, rev(unique(genus)))
  )

tmp2 <- distinct(tmp, genus, taxa_group_mod)

horizontal.breaks <- c()

for(i in unique(tmp2$taxa_group_mod)) {
  
  horizontal.breaks <- 
    c(horizontal.breaks, max(which(tmp2$taxa_group_mod == i)))
}

horizontal.breaks <- horizontal.breaks[horizontal.breaks != nrow(tmp2)]
horizontal.breaks <- nrow(tmp2) - horizontal.breaks
horizontal.breaks <- horizontal.breaks + 0.5

tmp %>%
  ggplot(aes(
    x = test_requested, 
    y = genus
  )) +
  xlab("Viral Test Type") +
  scale_x_discrete(position = "top") +
  geom_tile(aes(fill = log(1 + prop.num.for.plot)), color = "lightgray") +
  geom_text(aes(label = percent_mod)) +
  geom_hline(yintercept = horizontal.breaks, size = 0.4) +
  scale_fill_gradientn(colors = c("white", "firebrick"), limits = c(0, 0.75)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text.x = element_text(size = 14),
    axis.title.x = element_text(size = 20),
    text = element_text(size = 13),
    axis.title.y = element_blank()
  )
```
</details>

<details>
<summary><font size="+1.5"><b>Site-Level Summary Table</b></font></summary>

This table provides a site-level overview of in-country PREDICT-2 viral surveillance. For each site, the table outlines basic site characteristics as well as the total number of viruses and host taxa sampled from that site. 

```{r tables-2}

get_country_site_viruses2(view = FALSE, animal_virus_summary) %>% 
  mutate_all(
    cell_spec, format = "html", 
    bold = TRUE, color = text.color
  ) %>%
  kable(escape = FALSE, align = "c") %>%
  kable_styling(fixed_thead = TRUE)
```
</details>

```{r viral-host-range-prep, include = FALSE}

viral.name.harmonization <- read_csv(h("data", "hp3_to_p2_viral_name_harmonization.csv"))

all_equal(
  grep("PREDICT", sort(unique(t2$viral_species)), invert = TRUE, value = TRUE), 
  viral.name.harmonization$p2_virus_name
)

hp3.associations <- read_csv(h("data", "associations.csv")) %>%
  rename(
    virus_name = vVirusNameCorrected,
    host_name = hHostNameFinal
  ) %>%
  left_join(., viral.name.harmonization, by = c("virus_name" = "hp3_virus_name")) %>%
  filter(!is.na(p2_virus_name)) %>%
  mutate(
    viral_species = p2_virus_name,
    species_scientific_name = str_replace_all(host_name, "_", " "),
    project = rep("Previously Known", nrow(.))
  )

# "species" to exclude from P2 associations

species.to.exclude <- c("Rodentia")

p2.associations <- animal_virus_summary %>%
  distinct(viral_species, species_scientific_name) %>%
  filter(viral_species %in% unique(hp3.associations$viral_species)) %>%
  mutate(project = rep(paste("PREDICT-2", params$country), nrow(.))) %>%
  filter(
    !str_detect(species_scientific_name, " sp."),
    !(species_scientific_name %in% species.to.exclude)
  )

full.association.table <- hp3.associations %>%
  select(viral_species, species_scientific_name, project) %>%
  bind_rows(., p2.associations) %>%
  filter(viral_species %in% p2.associations$viral_species) %>%
  arrange(viral_species, species_scientific_name, project) %>%
  group_by(viral_species, species_scientific_name) %>%
  summarize(project = glue_collapse(project, sep = " and ")) %>%
  ungroup() %>%
  mutate(project = as.factor(project))
```

<details>
<summary><font size="+1.5"><b>Expansion of Known Viral Host Range</b></font></summary>

To examine the expansion of viral host range as a result of in-country PREDICT-2 sampling, here we show previously known viruses, as recorded in the host-virus association dataset of [Olival et al. 2017](https://www.nature.com/articles/nature22975). The number of known hosts for each virus are visualized, with hosts newly discovered as part of PREDICT sampling efforts indicated by the red portion of each bar.

```{r viral-host-range, fig.align = "center", fig.height = 8, fig.width = 12}

axis.title.size <- 22
axis.text.size <- 16
legend.text.size <- 18
template.colors <- wes_palette("Darjeeling1")[c(1, 3, 5)]
plot.colors <- if(sum(str_detect(full.association.table$project, " and ")) > 0) {
  template.colors
} else {
  template.colors[c(1, 3)]
}

full.association.table %>%
  mutate(viral_species = str_replace(viral_species, " \\(", "\n\\(")) %>%
  ggplot(aes(x = viral_species, fill = project)) +
  ylab("Number of known host species") +
  geom_bar() +
  scale_fill_manual(values = plot.colors) +
  theme_minimal() +
  theme(axis.title = element_text(size = axis.title.size),
        axis.title.x = element_blank(),
        axis.text = element_text(size = axis.text.size),
        axis.text.x = element_text(size = axis.text.size - 4, face = "bold"),
        legend.title = element_blank(),
        legend.text = element_text(size = legend.text.size),
        legend.position = "bottom")
```
</details>

```{r viral-curves-prep, include = FALSE}

# Define the viral test types and specific protocols of interest

tests.of.interest <- c("Coronaviruses", "Filoviruses", 
                       "Flaviviruses", "Paramyxoviruses")

protocols.of.interest <- c(
  "Modified Watanabe et al, RdRp gene",
  "Unpublished, UCD",
  "Moureau et al, NS5 gene",
  "Tong et al, PAR"
)

# Recover all specimens for which a viral test type of interest was conducted
# using the specified protocol of interest

specimens <- d2 %>%
  filter(
    test_requested %in% tests.of.interest,
    test_requested_protocol %in% protocols.of.interest
  ) %>%
  group_by(specimen_id, test_requested) %>%
  summarize(
    n = n(),
    n_tests = n_distinct(gains4_test_id),
    tests = glue_collapse(unique(test_requested), sep = ","),
    test_protocols = glue_collapse(unique(test_requested_protocol, sep = ","))
  ) %>%
  filter(
    n_tests == 1
  ) %>%
  pull(specimen_id)

# Create a data subset for viral curves plotting that contains only the
# specimens of interest for the viral test types of interest

d.subset <- d2 %>%
  filter(
    test_requested %in% tests.of.interest,
    test_requested_protocol %in% protocols.of.interest,
    specimen_id %in% specimens
  )

assertthat::assert_that(n_distinct(d.subset$specimen_id) == length(unique(specimens)))

# Create iNEXT objects

i.list <- create_ilist(d.subset, "test_requested", "specimen_id")
if(length(i.list) == 1) {x <- as.matrix(i.list[[1]])}
if(length(i.list) > 1) {x <- i.list}
if(length(i.list) > 0) {i.out <- iNEXT(x, q = 0, datatype = "incidence_raw")}
```

<details>
<summary><font size="+1.5"><b>Viral Discovery Curves</b></font></summary>

To provide model-based estimates of viral sampling completeness within country, here we generate viral discovery curves across four of the five priority PREDICT-2 viral groups. We have excluded influenza testing from this analysis since only one influenza species (Influenza A) was recovered globally in PREDICT-2. In order to preserve interpretability among curves, we have restricted the data included in this portion of the report. Specifically, we report only on specimens that were tested for the same viral test protocol within each viral test type. The viral test protocols considered here are: `r glue_collapse(paste0(protocols.of.interest, " (", tests.of.interest, ")"), sep = "; ")`. Thus, every specimen included in the figure was tested only once, with the viral test protocol indicated, for each viral test type.

```{r, viral-curves-plot, fig.align = "center", fig.height = 6, fig.width = 8}

if(length(i.list) > 0) {
  
  # Set plot characteristics and plot the iNEXT results
  
  axis.title.size <- 28
  axis.text.size <- 22
  legend.text.size <- 22
  template.colors <- wes_palette("Darjeeling1")[c(1:3, 5)]
  plot.colors <- template.colors[tests.of.interest %in% names(i.list)]
  
  ggiNEXT(i.out) +
    xlab("Number of specimens") + ylab("Viral diversity") +
    scale_color_manual(values = plot.colors, labels = names(i.list)) +
    scale_fill_manual(values = plot.colors, labels = names(i.list)) +
    scale_shape_manual(values = rep(19, length(i.list)), labels = names(i.list)) +
    guides(linetype = F) +
    theme_minimal() +
    theme(axis.title = element_text(size = axis.title.size),
          axis.text = element_text(size = axis.text.size),
          legend.title = element_blank(),
          legend.text = element_text(size = legend.text.size),
          legend.position = "bottom")
}
```
</details>

### Section 2: Viral Host Ranges and Risk Maps

Viral host ranges of mammalian species are shown over country risk maps below. Use the bottom-left icon to control the map display.  The listed viruses have been detected under PREDICT surveillance in mammalian species in `r params$country`.  Clicking on a virus displays global ranges from the International Union for Conservation of Nature (IUCN) for the host species in which the virus was detected (hover over polygons to see the host species names). Points on maps show where the host species was sampled in `r params$country`.  Circles with colored fills indicate detects and circles with white fills indicate non-detects (hover over points to see counts of animals tested).

Scroll to the bottom of the list from the bottom-left icon to toggle between the human population density layer, as estimated by the Center for International Earth Science Information Network (CIESIN), and the mammalian livestock density layer, based on a model developed by [Robinson et al. 2014](http://dx.doi.org/10.1371/journal.pone.0096084).  These density layers are shown only for `r params$country`.  Other EcoHealth Alliance PREDICT countries are outlined in white.

```{r get-map-data, include=FALSE}

# Get administrative borders of countries of interest
country_mod <-  mod_country(country) # for density rasters
country_eha <-  mod_country(eidith::eha_countries()) %>% unique() # for range layers

admin <- ne_countries(country = country_mod, type='countries', scale = 'large')
admin_eha <- ne_countries(country = country_eha, type='countries', scale = 'large')

# Centroids for setting view in leaflet
country_centroid <- CoordinateCleaner::countryref %>% 
  filter(name == countrycode(sourcevar = country_mod,
                             origin = "country.name",
                             destination = "country.name")) %>%
  slice(1)

# Get population density rasters
human_dens <- get_layers("gpw-v4-population-density_2015.tif", admin)
mammal_dens <- get_layers("summed_mammal_livestock.tif", admin)

# Get iucn ranges for species with viral detections
iucn <- st_read(h("data", "TERRESTRIAL_MAMMALS")) %>% # downloaded: https://www.iucnredlist.org/resources/spatial-data-download
  filter(presence == 1) %>%
  mutate(
    binomial = case_when(
      binomial == "Rattus arfakienis" ~ "Rattus arfakiensis",
      str_detect(binomial, "Oryx beisa ssp") ~ "Oryx beisa",
      TRUE ~ as.character(binomial)
    )
  )

iucn <- iucn %>%
  left_join(., read_csv(h("data", "iucn_to_hp3_taxonomic_harmonization.csv")),
            by = c("binomial" = "IUCN_name")) %>%
  mutate(binomial = ifelse(!is.na(hp3_zoo_prediction_name), hp3_zoo_prediction_name, binomial))

# Viral-species pairs
animal_viral_pairs <- read_csv(h("data", "viral_species_testing_by_host_and_site.csv")) %>%
  filter(country == params$country,
         species_scientific_name %in% unique(iucn$binomial)) # only keep host species that have ranges

viral.species.detected.in.country <- animal_viral_pairs %>% # identify specues with detects
  filter(n_animals_w_detections > 0) %>%
  pull(viral_species) %>%
  unique()

animal_viral_pairs <- filter(animal_viral_pairs, viral_species %in% viral.species.detected.in.country)
```

```{r maps, fig.align = "center"}

# set palettes
max_val_human <- ceiling(maxValue(human_dens))
pal_human <- colorBin(palette =
                        c("white","gray50", "black"),
                      #c("azure4", "yellow", "coral2"),
                      #c("mistyrose1", "coral", "darkred"),
                      domain = -1:max_val_human, na.color = "transparent")

max_val_mammal <- ceiling(maxValue(mammal_dens))
min_val_mammal <- floor(minValue(mammal_dens))
pal_mammal <- colorBin( c("white","gray50", "black"),
                        #palette = c("azure4", "yellow", "coral2"), 
                        domain = min_val_mammal:max_val_mammal, 
                        na.color = "transparent", pretty = TRUE, 
                        bins = 5)

opac <- 0.3
rad <- 5

# initiate leaflet map
lf <- leaflet() %>%
  addProviderTiles("CartoDB.DarkMatter") %>%
  addPolygons(data = admin_eha, fill = FALSE, stroke = TRUE, weight = 1, color = "white", opacity = 0.5) %>% # EHA outlines
  addFullscreenControl(position = "topright")

for(vir in viral.species.detected.in.country) {
  
  species_detects <- animal_viral_pairs %>%
    filter(
      viral_species == vir, 
      n_animals_w_detections > 0
    ) 
  
  species <- unique(species_detects$species_scientific_name)
  
  species_non_detects <- animal_viral_pairs %>%
    filter(
      viral_species == vir, 
      n_animals_w_detections == 0
    )
  
  pal_spec <- suppressWarnings(brewer.pal(length(species), "Set3"))
  
  if(length(species) < 11) {
    
    names(pal_spec) <- species
    
    for(spec in species) {
      
      iucn_sub <- iucn %>% filter(binomial==spec)
      
      lf <- lf %>%
        addPolygons(data = iucn_sub,
                    stroke = TRUE, color = unname(pal_spec[spec]), weight = 2, opacity = opac,
                    fill = TRUE, fillColor = unname(pal_spec[spec]), fillOpacity = opac,
                    label = spec,
                    group = vir) 
    }
    
    lf <- lf %>%
      addCircleMarkers(data = species_non_detects, radius = rad,
                       lng = ~jitter(site_longitude), lat = ~jitter(site_latitude), 
                       stroke = TRUE, color = ~unname(pal_spec[species_scientific_name]), weight = 1.5, opacity = 1,
                       fill = TRUE, fillColor = "#ffffff", fillOpacity = 1,
                       label = ~paste0("PREDICT ", species_scientific_name, " non-detect (", n_animals_tested, " animals tested)"),
                       group = vir) %>%
            addCircleMarkers(data = species_detects, radius = rad, 
                       lng = ~jitter(site_longitude), lat = ~jitter(site_latitude), 
                       stroke = FALSE, 
                       fill = TRUE, fillColor = ~unname(pal_spec[species_scientific_name]), fillOpacity = 1,
                       label = ~paste0("PREDICT ", species_scientific_name, " (", n_animals_tested, " animals tested, ", n_animals_w_detections, " animals positive)"),
                       group = vir) 

    
  } else { # n species > 10
    
    iucn_sub <- iucn %>% filter(binomial %in% species)
    
    lf <- lf %>%
      addPolygons(data = iucn_sub,
                  stroke = TRUE, color = "#7FC97F", weight = 2, opacity = opac,
                  fill = TRUE, fillColor = "#7FC97F", fillOpacity = opac,
                  label = htmltools::HTML(glue_collapse(species, "<br/>")),
                  group = vir) %>%
          addCircleMarkers(data = species_non_detects, radius = rad,
                       lng = ~jitter(site_longitude), lat = ~jitter(site_latitude), 
                       stroke = TRUE, color =  "#7FC97F", weight = 1.5, opacity = 1,
                       fill = TRUE, fillColor = "#ffffff", fillOpacity = 1,
                       label = ~paste0("PREDICT ", species_scientific_name, " non-detect (", n_animals_tested, " animals tested)"),
                       group = vir) %>%
            addCircleMarkers(data = species_detects, radius = rad, 
                       lng = ~jitter(site_longitude), lat = ~jitter(site_latitude), 
                       stroke = FALSE, 
                       fill = TRUE, fillColor = "#7FC97F", fillOpacity = 1,
                       label = ~paste0("PREDICT ", species_scientific_name, " (", n_animals_tested, " animals tested, ", n_animals_w_detections, " animals positive)"),
                       group = vir) 
    
  }
}

lf <- lf %>%
  # Human
  addRasterImage(x = human_dens, colors = pal_human, group = "Human", opacity = 1) %>%
  addLegend(pal = pal_human, values = values(human_dens), group = "Human", position = "bottomright",
            title =  "Human Population Density <br/> (Persons per Sq. Km)", 
            labFormat = labelFormat(digits = 0 ,transform = function(x) 10 ^ x)) %>%
  # Mammals
  addRasterImage(x = mammal_dens, colors = pal_mammal, opacity = 0.8, group = "Mammal") %>%
  addLegend(pal = pal_mammal, values = values(mammal_dens), group = "Mammal", position = "bottomright",
            title = "Mammal Livestock Density <br/> (Head per Sq. Km)" , labFormat = labelFormat(digits = 0)) %>%
  # User controlled layers
  addLayersControl(
    overlayGroups  = c("Human", "Mammal"), #  legend group only works when using overlayGroups
    baseGroups = c("None", sort(viral.species.detected.in.country)),
    options = layersControlOptions(collapsed = TRUE),
    position = "bottomleft"
  )  %>%
  hideGroup("Mammal") %>%
  setView(zoom = 3, lng = country_centroid$centroid.lon, lat = country_centroid$centroid.lat)

lf

```

### Section 3: Prioritization of Future Viral Discovery and Zoonotic Surveillance

```{r, missing-zoonoses-analysis-prep, include = FALSE}

mz <- read_csv(h("data", "hp3_zoo_predictions.csv")) %>%
  mutate(
    species = case_when(
      species == "Rattus_arfakienis" ~ "Rattus arfakiensis",
      TRUE ~ str_replace(species, "_", " ")
    )
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  filter(species != "Pteropus pelewensis ssp. yapensis") %>%
  left_join(., read_csv(h("data", "hp3_taxonomy_harmonization.csv")), by = "species") %>%
  mutate(species = 
           ifelse(!is.na(species_alt), 
                  paste0(species, "|", species_alt),
                  species)
  ) %>%
  separate_rows(species, sep = "\\|") %>%
  select(-species_alt) %>%
  arrange(desc(pred_mean)) %>%
  mutate(
    relative_zoonoses = case_when(
      pred_mean > quantile(pred_mean, c(0.33, 0.66))[2] ~ "High",
      pred_mean < quantile(pred_mean, c(0.33, 0.66)[1]) ~ "Low",
      TRUE ~ "Medium"
    )
  )

mammals.in.country <- read_csv(h("data", "mammal_country_lookup.csv")) %>%
  filter(country == params$country) %>%
  pull(binomial)

mz.subset <- filter(mz, species %in% mammals.in.country)

species.sampled.in.country <- d2 %>%
  mutate(
    species_scientific_name = str_replace(species_scientific_name, "cf. ", ""),
    species_scientific_name = word(species_scientific_name, 1, 2)
  ) %>%
  pull(species_scientific_name) %>%
  unique()

text.color <- ifelse(mz.subset$species %in% species.sampled.in.country, "#1B8925", "#BD0505")

specimen.count <- d2 %>%
  mutate(
    species_scientific_name = str_replace(species_scientific_name, "cf. ", ""),
    species_scientific_name = word(species_scientific_name, 1, 2)
  ) %>%
  group_by(species_scientific_name) %>%
  summarize(
    specimen_count = n_distinct(specimen_id, na.rm = T),
    virus_count = n_distinct(viral_species, na.rm = T),
    viruses_detected = ifelse(virus_count > 0, "Yes", "No")
  )

assertthat::assert_that(length(species.sampled.in.country) == nrow(specimen.count))

mz.subset <- left_join(mz.subset, specimen.count, by = c("species" = "species_scientific_name"))
```

<details>
<summary><font size="+1.5"><b>Sampling Prioritization Based on Missing Zoonoses</b></font></summary>

To help prioritize future viral surveillance in-country, we draw on the modeling work of [Olival et al. 2017](https://www.nature.com/articles/nature22975). Using a simplified version of the "missing zoonoses" model from that paper, we generated a list of host species occurring in-country and corresponding model-based estimates of the number of predicted unobserved zoonotic viruses residing in those hosts. These quantitative estimates, which are likely to be underestimates of true unobserved viral diversity, have been converted into broad risk categories here to simplify surveillance prioritization. Further, species are color-coded according to PREDICT-2 sampling history. Host species already sampled in-country for PREDICT-2 are indicated in green, along with the number of specimens collected from that species. Host species not sampled in PREDICT-2, and therefore of possible interest for future viral surveillance work, are highlighted in red.

```{r, missing-zoonoses-analysis}

mz.subset %>% 
  select(1, 9, 10, 12) %>%
  mutate(
    specimen_count = ifelse(is.na(specimen_count), 0, specimen_count),
    viruses_detected = ifelse(is.na(viruses_detected), "", viruses_detected)) %>%
  mutate_at(
    vars(species),
    cell_spec, format = "html", 
    bold = TRUE, color = text.color
  ) %>%
  mutate_at(
    vars(-species),
    cell_spec, format = "html", 
    bold = TRUE, color = "#787272"
  ) %>%
  rename(
    `Host Species` = species,
    `Relative No. of Unobserved Zoonotic Viruses` = relative_zoonoses,
    `No. of Specimens Collected` = specimen_count,
    `Viruses Detected In-Country?` = viruses_detected
  ) %>%
  kable(escape = FALSE, align = "c") %>%
  kable_styling(fixed_thead = TRUE)
```
</details>

# References

Center for International Earth Science Information Network - CIESIN - Columbia University. 2016. Gridded Population of the World, Version 4 (GPWv4): Population Density. Palisades, NY: NASA Socioeconomic Data and Applications Center (SEDAC). http://dx.doi.org/10.7927/H4NP22DQ. Accessed 21 December 2017.

IUCN v6.2. The IUCN Red List of Threatened Species. Version 6.2. http://www.iucnredlist.org. Downloaded on 24 July 2019.

Olival, K.J., Hosseini, P.R., Zambrana-Torrelio, C., Ross, N., Bogich, T.L. and Daszak, P. 2017. Host and viral traits predict zoonotic spillover from mammals. Nature 546: 646-650. http://dx.doi.org/10.1038/nature22975

Robinson, T.P., Wint, G.R.W., Conchedda, G., Van Boeckel, T.P., Ercoli, V., Palamara, E., Cinardi, G., D’Aietti, L., Hay, S.I. and Gilbert, M. 2014. Mapping the global distribution of livestock. PLoS ONE 9: e96084. http://dx.doi.org/10.1371/journal.pone.0096084
