---
params:
  country: "Thailand"
title: 'PREDICT M&A Report: `r params$country`'
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: false
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(DT)
library(eidith)
library(glue)
library(iNEXT)
library(kableExtra)
library(tidyverse)
library(wesanderson)
h <- here::here
walk(list.files(h("R/"), full.names = TRUE),
     source, echo = FALSE, verbose = FALSE)
country <- params$country
```

![](./media/predict-logos.png){width="100%"}

#### _Click on the_ ▶ _︎arrows to expand sections._

```{r read-data}

# Load EIDITH data tables

e <- ed_events() %>% 
  filter(country == !!country)
a <- ed_animals()
s <- ed_specimens()
t <- ed_tests()
v <- ed_viruses()
ts <- ed_testspecimen()

e2 <- ed2_events() %>%
  filter(country == !!country)
a2 <- ed2_animals() %>% 
  select(-c(integer_id, gains4_event_id, gains4_sample_unit_id)) %>%
  mutate(class = stringr::str_to_sentence(class))
s2 <- ed2_specimens() %>% 
  arrange(desc(integer_id)) %>%
  distinct(specimen_id, .keep_all = TRUE) %>%
  select(-c(integer_id, gains4_sample_unit_id, gains4_specimen_id))
t2 <- ed2_tests() %>%
  select(-c(integer_id, gains4_specimen_id)) %>%
  mutate(
    virus = case_when(
      virus == "" ~ NA_character_,
      TRUE ~ virus
    )
  )
ti <- ed2_test_interpreted() %>%
  select(-c(integer_id))

# Split out P2 viral co-infection data

t2 <- t2 %>%
  mutate(
    sequence = case_when(
      str_detect(sequence, "\\|") & !(str_detect(virus, "\\|")) ~ 
        str_replace(sequence, "\\|", ";"),
      TRUE ~ sequence
    )
  )

t2 <- separate_rows(t2, virus, sequence, sep = "\\|")

# Modify viral names and detection data

v <- v %>%
  mutate(viral_species = stringi::stri_replace_first_regex(
    virus_name, "(new\\s)?strain\\sof\\s", ""))

t2 <- t2 %>%
  mutate(
    viral_species = stringi::stri_replace_first_regex(virus, "(new\\s)?strain\\sof\\s", ""),
    viral_species = str_replace(viral_species, "Alpha coronavirus", "Alphacoronavirus"),
    viral_species = str_replace(viral_species, "bat coronavirus", "Bat coronavirus"),
    viral_species = str_replace(viral_species, "Bat Coronavirus", "Bat coronavirus")
  ) %>%
  mutate(virus_detected = ifelse(confirmation_result == "Positive", 1, 0))

# Join across all tables to get complete data

d <- left_join(e, a, by = "event_id") %>%
  left_join(s, by = "animal_id") %>%
  left_join(ts, by = "specimen_id") %>%
  left_join(t, by = "test_id") %>%
  left_join(v, by = "test_id")

d2 <- full_join(e2, a2, by = c("event_name", "project")) %>%
  left_join(s2, by = c("animal_id" = "animal_human_id", "project")) %>%
  left_join(t2, by = c("specimen_id", "project"))
```

<details>
<summary>Summary Tables</summary>
``` {r tables}

animal.grouping.vars <-
  c("country", "concurrent_sampling_site", "site_name",
    "human_density_impact", "taxa_group", "species_scientific_name", "viral_species")

animal_virus_summary <- d2 %>%
  filter(!is.na(viral_species)) %>%
  group_by_at(vars(one_of(animal.grouping.vars))) %>%
  summarize(n_positives = sum(virus_detected)) %>%
  ungroup() %>%
  arrange(country, site_name, taxa_group, species_scientific_name, viral_species, n_positives)

get_country_site_viruses2() %>% 
  kable(format = "html", escape = FALSE) %>%
  kable_styling()
```
</details>

```{r viral-curves-prep, include = FALSE}

axis.title.size <- 28
axis.text.size <- 22
legend.text.size <- 22
template.colors <- wes_palette("Darjeeling1")[1:5]

tests.of.interest <- c("Coronaviruses", "Filoviruses", "Flaviviruses",
                       "Influenzas", "Paramyxoviruses")
protocols.of.interest <- c(
  "Modified Watanabe et al, RdRp gene",
  "Unpublished, UCD",
  "Moureau et al, NS5 gene",
  "Anthony et al, M gene",
  "Tong et al, PAR"
)

specimens <- d2 %>%
  filter(
    test_requested %in% tests.of.interest,
    test_requested_protocol %in% protocols.of.interest
  ) %>%
  group_by(specimen_id, test_requested) %>%
  summarize(
    n = n(),
    n_tests = n_distinct(gains4_test_id),
    tests = glue_collapse(unique(test_requested), sep = ","),
    test_protocols = glue_collapse(unique(test_requested_protocol, sep = ","))
  ) %>%
  filter(
    n_tests == 1
  ) %>%
  pull(specimen_id)

d.subset <- d2 %>%
  filter(
    test_requested %in% tests.of.interest,
    test_requested_protocol %in% protocols.of.interest,
    specimen_id %in% specimens
  )

assertthat::assert_that(n_distinct(d.subset$specimen_id) == length(unique(specimens)))

i.list <- create_ilist(d.subset, "test_requested", "specimen_id")

i.out <- iNEXT(i.list, q = 0, datatype = "incidence_raw")

plot.colors <- template.colors[tests.of.interest %in% unique(i.out$AsyEst$Site)]
```

``` {r, viral-curves-plot}

ggiNEXT(i.out) +
  scale_color_manual(values = plot.colors) +
  scale_fill_manual(values = plot.colors) +
  xlab("Number of specimens") + ylab("Viral diversity") +
  scale_shape_manual(values = rep(19, length(i.list))) +
  guides(linetype = F) +
  theme_minimal() +
  theme(axis.title = element_text(size = axis.title.size),
        axis.text = element_text(size = axis.text.size),
        legend.title = element_blank(),
        legend.text = element_text(size = legend.text.size),
        legend.position = "bottom")
```
