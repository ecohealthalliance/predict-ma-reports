---
params:
  country: "Thailand"
title: 'PREDICT M&A Report: `r params$country`'
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(leaflet)
library(raster)
library(maptools)
library(sf)
library(DT)
library(eidith)
library(glue)
library(iNEXT)
library(kableExtra)
library(tidyverse)
library(wesanderson)
h <- here::here
walk(list.files(h("R/"), full.names = TRUE),
     source, echo = FALSE, verbose = FALSE)
country <- params$country
```

![](./media/predict-logos.png){width="100%"}

#### _Click on the_ ▶ _︎arrows to expand sections._

```{r read-data, include = FALSE}
# Load EIDITH data tables
e <- ed_events() %>% 
  filter(country == !!params$country) # events filtered to country
a <- ed_animals()
s <- ed_specimens()
t <- ed_tests()
v <- ed_viruses()
ts <- ed_testspecimen()
e2 <- ed2_events() %>%
  mutate(country = ifelse(country %in% c("Malaysia, Peninsular", "Malaysia, Sabah"), "Malaysia", country)) %>%
  filter(country == !!params$country) %>% # events filtered to country
  arrange(desc(integer_id)) %>%
  distinct(event_name, .keep_all = TRUE)
a2 <- ed2_animals() %>% 
  select(-c(integer_id, gains4_event_id, gains4_sample_unit_id))
s2 <- ed2_specimens() %>% 
  select(-c(integer_id, gains4_sample_unit_id))
t2 <- ed2_tests() %>%
  select(-c(integer_id))
ti <- ed2_test_interpreted() %>%
  arrange(desc(integer_id)) %>%
  distinct(gains4_test_id, .keep_all = TRUE) %>%
  select(
    -c(integer_id, is_outbreak_testing, season,
       lab_name, real_time_positive_control_value_1, real_time_positive_control_value_2,
       real_time_internal_control_value, real_time_ct_value, lab_name_confirmation,
       test_status, date_govt_approved_release)
  )
# Modify animal taxonomy information
a2 <- a2 %>%
  mutate(
    class = stringr::str_to_sentence(class),
    order = stringr::str_to_sentence(order),
    family = stringr::str_to_sentence(family),
    taxa_group_mod = case_when(
      taxa_group == "cats" ~ "carnivores",
      taxa_group == "dogs" ~ "carnivores",
      taxa_group == "poultry/other fowl" ~ "birds",
      family == "Sciuridae" ~ "rodents/shrews",
      TRUE ~ taxa_group
    ),
    species_scientific_name = case_when(
      species_scientific_name == "Syncerus Caffer" ~ "Syncerus caffer",
      TRUE ~ species_scientific_name
    )
  )
# Split out P2 viral co-infection data
t2 <- t2 %>%
  mutate(
    sequence = case_when(
      str_detect(sequence, "\\|") & !(str_detect(virus, "\\|")) ~ 
        str_replace(sequence, "\\|", ";"),
      str_detect(sequence, "\\|") & is.na(virus) ~ 
        str_replace(sequence, "\\|", ";"),
      TRUE ~ sequence
    )
  )
t2 <- separate_rows(t2, virus, sequence, sep = "\\|")
# Modify virus name (in new "viral_species" column) and detection data
v <- v %>%
  mutate(viral_species = stringi::stri_replace_first_regex(
    virus_name, "(new\\s)?strain\\sof\\s", ""))
t2 <- t2 %>%
  mutate(
    virus = case_when(
      virus == "" ~ NA_character_,
      TRUE ~ virus
    ),
    viral_species = stringi::stri_replace_first_regex(virus, "(new\\s)?strain\\sof\\s", ""),
    viral_species = ifelse(str_detect(viral_species, "(OC43)"), "Betacoronavirus 1 (OC43)", viral_species),
    viral_species = ifelse(str_detect(viral_species, "MJ/67C"), "Hipposideros bat alphacoronavirus MJ/67C", viral_species),
    viral_species = str_replace(viral_species, "Bat Coronavirus", "Bat coronavirus"),
    viral_species = str_replace(viral_species, " Bat ", " bat "),
    virus_detected = ifelse(confirmation_result == "Positive", 1, 0)
  ) %>%
  left_join(., read_csv(h("data", "viral_species_modifications.csv")), by = "viral_species") %>%
  mutate(viral_species = ifelse(!is.na(viral_species_mod), viral_species_mod, viral_species)) %>%
  select(-viral_species_mod)
# Join across all tables to get complete data
d <- left_join(e, a, by = "event_id") %>%
  left_join(s, by = "animal_id") %>%
  left_join(ts, by = "specimen_id") %>%
  left_join(t, by = "test_id") %>%
  left_join(v, by = "test_id")
d2 <- left_join(e2, a2, by = c("event_name", "project")) %>%
  left_join(s2, by = c("animal_id" = "animal_human_id", "project")) %>%
  left_join(t2, by = c("specimen_id", "gains4_specimen_id", "project")) %>%
  left_join(ti, by = c("gains4_specimen_id", "gains4_test_id", "project"))
```

### Section 1: Summary of Viral Findings

<details>
<summary>Virus-Level Summary Table</summary>
```{r tables-1}
animal.grouping.vars <-
  c("country", "concurrent_sampling_site", "site_name",
    "human_density_impact", "taxa_group_mod", 
    "species_scientific_name", "viral_species")
animal_virus_summary <- d2 %>%
  filter(!is.na(viral_species)) %>%
  mutate(
    species_scientific_name = case_when(
      str_detect(species_scientific_name, " cf. ") ~ 
        str_replace(species_scientific_name, " cf. ", " "),
      TRUE ~ species_scientific_name
    )
  ) %>%
  group_by_at(vars(one_of(animal.grouping.vars))) %>%
  summarize(n_positives = sum(virus_detected)) %>%
  ungroup() %>%
  arrange(country, site_name, taxa_group_mod, 
          species_scientific_name, viral_species, n_positives)
text.color <- "#787272"
get_country_viruses() %>%
  left_join(., read_csv(h("data", "viral_species_country_lookup.csv")), 
            by = c(`Virus Name` = "viral_species")) %>%
  mutate(country = ifelse(country == params$country, NA_character_, country)) %>%
  group_by_at(vars(-country)) %>%
  summarize("Concurrent Detections" = paste(unique(country), collapse = "\n")) %>%
  ungroup() %>%
  mutate(
    `Concurrent Detections` = str_replace(`Concurrent Detections`, "NA\n", ""),
    `Concurrent Detections` = str_replace(`Concurrent Detections`, "\nNA", "")
  ) %>%
  mutate_all(
    cell_spec, format = "html", 
    bold = TRUE, color = text.color
  ) %>%
  kable(escape = FALSE, align = "c") %>%
  kable_styling(fixed_thead = TRUE)
```
</details>

<details>
<summary>Viral Testing Heatmap</summary>
```{r heatmap, fig.align = "center", fig.width = 10}
# Plot country-level heat maps of viral detections in specimens
tests.of.interest <- c("Coronaviruses", "Filoviruses", "Flaviviruses",
                       "Influenzas", "Paramyxoviruses")
tmp <- d2 %>%
  mutate(
    family = case_when(
      is.na(family) ~ "Unknown",
      TRUE ~ family
    ),
    genus = case_when(
      is.na(genus) ~ "Unknown",
      TRUE ~ genus
    )
  ) %>%
  filter(test_requested %in% tests.of.interest) %>%
  arrange(gains4_test_id, desc(virus_detected)) %>%
  distinct(gains4_test_id, .keep_all = TRUE) %>%
  group_by(taxa_group_mod, genus, test_requested) %>%
  summarize(
    n_tests = n_distinct(gains4_test_id),
    n_positives = sum(virus_detected, na.rm = TRUE),
    prop = n_positives/n_tests,
    percent = round(n_positives/n_tests*100, digits = 1),
    percent_mod = paste0(percent, "% (", n_tests, ")")
  ) %>%
  ungroup() %>%
  filter(
    !is.na(taxa_group_mod),
    !is.na(test_requested)
  ) %>%
  arrange(taxa_group_mod, genus) %>%
  mutate(
    genus = paste0(genus, " (", taxa_group_mod, ")"),
    genus = factor(genus, rev(unique(genus)))
  )
tmp2 <- distinct(tmp, genus, taxa_group_mod)
horizontal.breaks <- c()
for(i in unique(tmp2$taxa_group_mod)) {
  
  horizontal.breaks <- 
    c(horizontal.breaks, max(which(tmp2$taxa_group_mod == i)))
}
horizontal.breaks <- horizontal.breaks[horizontal.breaks != nrow(tmp2)]
horizontal.breaks <- nrow(tmp2) - horizontal.breaks
horizontal.breaks <- horizontal.breaks + 0.5
tmp %>%
  ggplot(aes(
    x = test_requested, 
    y = genus
  )) +
  xlab("Viral Test Type") +
  scale_x_discrete(position = "top") +
  geom_tile(aes(fill = log(1 + prop)), color = "lightgray") +
  geom_text(aes(label = percent_mod)) +
  geom_hline(yintercept = horizontal.breaks, size = 0.4) +
  scale_fill_gradientn(colors = c("white", "firebrick"), limits = c(0, 0.7)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text.x = element_text(size = 14),
    axis.title.x = element_text(size = 20),
    text = element_text(size = 13),
    axis.title.y = element_blank()
  )
```
</details>

<details>
<summary>Site-Level Summary Table</summary>
```{r tables-2}
get_country_site_viruses2() %>% 
  mutate_all(
    cell_spec, format = "html", 
    bold = TRUE, color = text.color
  ) %>%
  kable(escape = FALSE, align = "c") %>%
  kable_styling(fixed_thead = TRUE)
```
</details>

```{r viral-curves-prep, include = FALSE}
# Define the viral test types and specific protocols of interest
tests.of.interest <- c("Coronaviruses", "Filoviruses", "Flaviviruses",
                       "Influenzas", "Paramyxoviruses")
protocols.of.interest <- c(
  "Modified Watanabe et al, RdRp gene",
  "Unpublished, UCD",
  "Moureau et al, NS5 gene",
  "Anthony et al, M gene",
  "Tong et al, PAR"
)
# Recover all specimens for which a viral test type of interest was conducted
# using the specified protocol of interest
specimens <- d2 %>%
  filter(
    test_requested %in% tests.of.interest,
    test_requested_protocol %in% protocols.of.interest
  ) %>%
  group_by(specimen_id, test_requested) %>%
  summarize(
    n = n(),
    n_tests = n_distinct(gains4_test_id),
    tests = glue_collapse(unique(test_requested), sep = ","),
    test_protocols = glue_collapse(unique(test_requested_protocol, sep = ","))
  ) %>%
  filter(
    n_tests == 1
  ) %>%
  pull(specimen_id)
# Create a data subset for viral curves plotting that contains only the
# specimens of interest for the viral test types of interest
d.subset <- d2 %>%
  filter(
    test_requested %in% tests.of.interest,
    test_requested_protocol %in% protocols.of.interest,
    specimen_id %in% specimens
  )
assertthat::assert_that(n_distinct(d.subset$specimen_id) == length(unique(specimens)))
# Create iNEXT objects
i.list <- create_ilist(d.subset, "test_requested", "specimen_id")
if(length(i.list) == 1) {x <- as.matrix(i.list[[1]])}
if(length(i.list) > 1) {x <- i.list}
i.out <- iNEXT(x, q = 0, datatype = "incidence_raw")
```

<details>
<summary>Viral Discovery Curves</summary>
```{r, viral-curves-plot, fig.align = "center", fig.height = 6, fig.width = 8}
if(length(i.list) > 0) {
  
  # Set plot characteristics and plot the iNEXT results
  axis.title.size <- 28
  axis.text.size <- 22
  legend.text.size <- 22
  template.colors <- wes_palette("Darjeeling1")[1:5]
  plot.colors <- template.colors[tests.of.interest %in% names(i.list)]
  ggiNEXT(i.out) +
    xlab("Number of specimens") + ylab("Viral diversity") +
    scale_color_manual(values = plot.colors, labels = names(i.list)) +
    scale_fill_manual(values = plot.colors, labels = names(i.list)) +
    scale_shape_manual(values = rep(19, length(i.list)), labels = names(i.list)) +
    guides(linetype = F) +
    theme_minimal() +
    theme(axis.title = element_text(size = axis.title.size),
          axis.text = element_text(size = axis.text.size),
          legend.title = element_blank(),
          legend.text = element_text(size = legend.text.size),
          legend.position = "bottom")
}
```
</details>


### Section 2: Current-State-of-Knowledge Risk Maps
```{r get-map-data, include=FALSE}
# Get site locations
sites <- e2 %>% 
  dplyr::select(country, site_latitude, site_longitude, concurrent_sampling_site) %>% 
  mutate_at(vars(site_latitude, site_longitude), ~as.numeric(.)) %>%
  distinct()

# Get administrative borders of countries of interest
country_mod <-  mod_country(country) # for density rasters
country_eha <-  mod_country(eidith::eha_countries()) %>% unique() # for range layers

data("wrld_simpl")
admin <- wrld_simpl[wrld_simpl@data$NAME %in% country_mod, ] 
admin_eha <- wrld_simpl[wrld_simpl@data$NAME %in% country_eha, ] %>% st_as_sf()

# population density
human_dens <- get_layers("gpw-v4-population-density_2015.tif", admin)
mammal_dens <- get_layers("summed_mammal_livestock.tif", admin)

# iucn ranges
iucn <- st_read(h("data", "map-layers", "TERRESTRIAL_MAMMALS")) %>% # downloaded: https://www.iucnredlist.org/resources/spatial-data-download
  filter(presence == 1) %>%
  mutate(
    binomial = case_when(
      binomial == "Rattus arfakienis" ~ "Rattus arfakiensis",
      str_detect(binomial, "Oryx beisa ssp") ~ "Oryx beisa",
      TRUE ~ as.character(binomial)
    )
  )

iucn <- iucn %>%
  left_join(., read_csv(h("data", "iucn_to_hp3_taxonomic_harmonization.csv")),
            by = c("binomial" = "IUCN_name")) %>%
  mutate(binomial = ifelse(!is.na(hp3_zoo_prediction_name), hp3_zoo_prediction_name, binomial))

iucn_detects <- iucn %>%
  filter(binomial %in% unique(get_country_viruses()$`Species Names` ))
```

```{r maps}
max_val_human <- ceiling(maxValue(human_dens))
pal_human <- colorBin(palette = c("azure4", "yellow", "coral2"), domain = -1:max_val_human, na.color = "transparent")

max_val_mammal <- ceiling(maxValue(mammal_dens))
min_val_mammal <- floor(minValue(mammal_dens))

pal_mammal <- colorBin(palette = c("azure4", "yellow", "coral2"), domain = min_val_mammal:max_val_mammal, na.color = "transparent", pretty = TRUE, bins = 5)

lf <- leaflet() %>% 
  addProviderTiles("CartoDB.Positron", group = "Base") 

for(spec in unique(iucn_detects$binomial)){
  
  iucn_sub <- iucn_detects %>% filter(binomial==spec)
  
  lf <- lf %>%
    addPolygons(data = iucn_sub, stroke = TRUE, weight = 2, color = "green", fill = FALSE, group = spec )
}

lf <- lf %>%
  # Human
  addRasterImage(x = human_dens, colors = pal_human, opacity = 0.8, group = "Human") %>%
  addLegend(pal = pal_human, values = values(human_dens), group = "Human", position = "bottomright",
            title = "Human Population Density" , labFormat = labelFormat(digits = 0 ,transform = function(x) 10 ^ x)) %>%
  # Mammals
  # addRasterImage(x = mammal_dens, colors = pal_mammal, opacity = 0.8, group = "Mammal") %>%
  # addLegend(pal = pal_mammal, values = values(mammal_dens), group = "Mammal", position = "bottomright",
  #           title = "Mammal Livestock Density" , labFormat = labelFormat(digits = 0)) %>%
  # User controlled layers
  addLayersControl(
    baseGroups = unique(iucn_detects$binomial),
    #overlayGroups  = c("Human", "Mammal"),
    options = layersControlOptions(collapsed = FALSE),
    position = "bottomleft"
  ) 


lf

```

### Section 3: Prioritization of Future Viral Discovery and Zoonotic Surveillance

<details>
<summary>Sampling Prioritization Based on Missing Zoonoses</summary>
```{r, missing-zoonoses-analysis}
mz <- read_csv(h("data", "hp3_zoo_predictions.csv")) %>%
  mutate(species = str_replace(species, "_", " ")) %>%
  mutate_if(is.numeric, round, 2) %>%
  filter(species != "Pteropus pelewensis ssp. yapensis") %>%
  left_join(., read_csv(h("data", "hp3_taxonomy_harmonization.csv")), by = "species") %>%
  mutate(species = 
           ifelse(!is.na(species_alt), 
                  paste0(species, "|", species_alt),
                  species)
  ) %>%
  separate_rows(species, sep = "\\|") %>%
  select(-species_alt) %>%
  arrange(desc(pred_mean))
mammals.in.country <- read_csv(h("data", "mammal_country_lookup.csv")) %>%
  filter(country == params$country) %>%
  pull(binomial)
mz.subset <- filter(mz, species %in% mammals.in.country)
species.sampled.in.country <- d2 %>%
  mutate(
    species_scientific_name = str_replace(species_scientific_name, "cf. ", ""),
    species_scientific_name = word(species_scientific_name, 1, 2)
  ) %>%
  pull(species_scientific_name) %>%
  unique()
text.color <- ifelse(mz.subset$species %in% species.sampled.in.country, "#1B8925", "#BD0505")
mz.subset %>% 
  select(1:2) %>%
  rename(
    `Host Species` = species,
    `Predicted Missing Zoonoses` = pred_mean
  ) %>%
  mutate_if(
    is.character,
    cell_spec, format = "html", 
    bold = TRUE, color = text.color
  ) %>%
  mutate_if(
    is.numeric,
    cell_spec, format = "html", 
    bold = TRUE, color = "#787272"
  ) %>%
  kable(escape = FALSE, align = "c") %>%
  kable_styling(fixed_thead = TRUE)
```
</details>
