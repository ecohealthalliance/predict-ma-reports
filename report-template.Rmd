---
params:
  country: "Thailand"
title: 'EcoHealth Alliance PREDICT M&A Report: `r params$country`'
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# Load packages
library(CoordinateCleaner)
library(countrycode)
library(cowplot)
library(DT)
library(eidith)
library(glue)
library(iNEXT)
library(kableExtra)
library(leaflet)
library(leaflet.extras)
library(raster)
library(RColorBrewer)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(tidyverse)

h <- here::here
walk(list.files(h("R/"), full.names = TRUE), source, echo = FALSE, verbose = FALSE)

# Create a variable defining the country for the report
report_country <- params$country

# Create a colorblind-friendly color palette for plotting throughout
cb_palette <- c("#D55E00", "#009E73", "#999999", "#E69F00", "#56B4E9")
```

<script>
$(function () {
  $('[data-toggle="tooltip"]').tooltip()
})
</script>

![](./media/predict-logos.png){width="100%"}

**This report is meant to provide a broad overview of `r report_country` PREDICT-2 viral findings in animals, and present those findings with additional data and analyses to help understand viral host range, geographic risk, and future sampling targets for `r report_country`.** *Human viral findings are not addressed here*. Behavioral Risk outputs and data summaries are available via other tools and the Interim Data Review (IDR) report on EIDITH. Additional summaries of `r report_country` surveillance data can also be found via the Surveillance Activities and Risk Characterization reports on EIDITH. This report includes all `r report_country` animal data currently available in EIDITH, both government-approved and pending approval, and is designed for country-coordinators and country teams to explore their data further. Please note that, where relevant, information about viral detections in *other countries* are provided for general context and **only include government-approved data** as already publicly available on [HealthMap](https://www.healthmap.org/predict/). 

#### _Click on the "Expand / Collapse" buttons to view report subsections._

```{r read-data, include = FALSE}

# Load EIDITH data tables

e <- ed_events() %>% 
  mutate(country = ifelse(country %in% c("Malaysia, Peninsular", "Malaysia, Sabah"), "Malaysia", country)) %>%
  filter(country == !!report_country) # events filtered to country
a <- ed_animals()
s <- ed_specimens()
t <- ed_tests()
v <- ed_viruses()
ts <- ed_testspecimen()

e2 <- ed2_events() %>%
  mutate(country = ifelse(country %in% c("Malaysia, Peninsular", "Malaysia, Sabah"), "Malaysia", country)) %>%
  filter(country == !!report_country) %>% # events filtered to country
  arrange(desc(integer_id)) %>%
  distinct(event_name, .keep_all = TRUE)
a2 <- ed2_animals() %>% 
  select(-c(integer_id, gains4_event_id, gains4_sample_unit_id))
s2 <- ed2_specimens() %>% 
  select(-c(integer_id, gains4_sample_unit_id))
t2 <- ed2_tests() %>%
  select(-c(integer_id))
ti <- ed2_test_interpreted() %>%
  arrange(desc(integer_id)) %>%
  distinct(gains4_test_id, .keep_all = TRUE) %>%
  select(
    -c(integer_id, is_outbreak_testing, season,
       lab_name, real_time_positive_control_value_1, real_time_positive_control_value_2,
       real_time_internal_control_value, real_time_ct_value, lab_name_confirmation,
       test_status, date_govt_approved_release)
  )

# Modify animal taxonomy information

a2 <- a2 %>%
  mutate(
    class = stringr::str_to_sentence(class),
    order = stringr::str_to_sentence(order),
    family = stringr::str_to_sentence(family),
    taxa_group_mod = case_when(
      taxa_group == "cats" ~ "carnivores",
      taxa_group == "dogs" ~ "carnivores",
      taxa_group == "poultry/other fowl" ~ "birds",
      family == "Sciuridae" ~ "rodents/shrews",
      TRUE ~ taxa_group
    ),
    species_scientific_name = case_when(
      species_scientific_name == "Mus musculus cf. castaneus" ~ "Mus musculus",
      species_scientific_name == "Syncerus Caffer" ~ "Syncerus caffer",
      str_detect(species_scientific_name, " cf. ") ~ str_replace(species_scientific_name, " cf. ", " "),
      str_count(species_scientific_name, " ") == 2 ~ word(species_scientific_name, 1, 2),
      TRUE ~ species_scientific_name
    )
  )

# Split out P2 viral co-infection data

t2 <- t2 %>%
  mutate(
    sequence = case_when(
      str_detect(sequence, "\\|") & !(str_detect(virus, "\\|")) ~ 
        str_replace(sequence, "\\|", ";"),
      str_detect(sequence, "\\|") & is.na(virus) ~ 
        str_replace(sequence, "\\|", ";"),
      TRUE ~ sequence
    )
  )

t2 <- separate_rows(t2, virus, sequence, sep = "\\|")

# Modify virus name (in new "viral_species" column) and detection data

v <- v %>%
  mutate(viral_species = stringi::stri_replace_first_regex(
    virus_name, "(new\\s)?strain\\sof\\s", ""))

t2 <- t2 %>%
  mutate(
    virus = case_when(
      virus == "" ~ NA_character_,
      TRUE ~ virus
    ),
    viral_species = stringi::stri_replace_first_regex(virus, "(new\\s)?strain\\sof\\s", ""),
    viral_species = ifelse(str_detect(viral_species, "(OC43)"), "Betacoronavirus 1 (OC43)", viral_species),
    viral_species = ifelse(str_detect(viral_species, "MJ/67C"), "Hipposideros bat alphacoronavirus MJ/67C", viral_species),
    viral_species = ifelse(str_detect(viral_species, "(PPR)"), "Peste des petits ruminants (PPR)", viral_species),
    viral_species = ifelse(viral_species == "Human Coronavirus 229E (Human strain)", "Coronavirus 229E (Human strain)", viral_species),
    viral_species = str_replace(viral_species, "Bat Coronavirus", "Bat coronavirus"),
    viral_species = str_replace(viral_species, " Bat ", " bat "),
    virus_detected = ifelse(confirmation_result == "Positive", 1, 0)
  ) %>%
  left_join(., read_csv(h("data", "viral_species_modifications.csv")), by = "viral_species") %>%
  mutate(viral_species = ifelse(!is.na(viral_species_mod), viral_species_mod, viral_species)) %>%
  select(-viral_species_mod)

# Join across all tables to get complete data

d <- left_join(e, a, by = "event_id") %>%
  left_join(s, by = "animal_id") %>%
  left_join(ts, by = "specimen_id") %>%
  left_join(t, by = "test_id") %>%
  left_join(v, by = "test_id")

d2 <- left_join(e2, a2, by = c("event_name", "project")) %>%
  left_join(s2, by = c("animal_id" = "animal_human_id", "project")) %>%
  left_join(t2, by = c("specimen_id", "gains4_specimen_id", "project")) %>%
  left_join(ti, by = c("gains4_specimen_id", "gains4_test_id", "project"))
```

### Section 1: Summary of Viral Findings

#### Virus-Level Summary Table 

<button class="btn btn-primary btn-block" type="button" data-toggle="collapse" data-target="#vir-sum-table" aria-expanded="false" aria-controls="vir-sum-table" color="grey">
    Expand / Collapse
</button>

<div class="collapse" id="vir-sum-table">
\newline  
  
This table provides an overview of all `r report_country` viral findings in animals. For each unique virus detected in-country, the table indicates the number of times it was detected, the host taxonomic groups and species in which these detections occurred, and the associated sites. Finally, to add broader context to viral findings beyond `r report_country`'s borders, the final column of the table lists other PREDICT-2 countries in which the same virus was found and approved for government release, highlighting the potential geographic range of each virus.

**Please note you may need to scroll horizontally within the table to view all columns.**

```{r tables-1}

animal.grouping.vars <-
  c("country", "concurrent_sampling_site", "site_name", "disease_transmission_interfaces", "human_density_impact", 
    "class", "taxa_group_mod", "species_scientific_name", 
    "test_requested", "viral_species", "human_threat")

animal_virus_summary <- d2 %>%
  filter(!is.na(viral_species)) %>%
  group_by_at(vars(one_of(animal.grouping.vars))) %>%
  summarize(n_positives = sum(virus_detected)) %>%
  ungroup() %>%
  arrange(country, site_name, taxa_group_mod, 
          species_scientific_name, viral_species, n_positives)

threat.interpretation <- d2 %>%
  filter(
    !is.na(viral_species),
    human_threat == "yes"
  ) %>%
  distinct(viral_species, interpretation) %>%
  mutate(interpretation_length = str_length(interpretation)) %>%
  arrange(viral_species, interpretation_length) %>%
  distinct(viral_species, .keep_all = TRUE) %>%
  select(-interpretation_length)

text.color <- "#787272"

get_country_viruses(view = FALSE, animal_virus_summary) %>%
  left_join(., read_csv(h("data", "viral_species_country_lookup.csv")), 
            by = c(`Virus Name` = "viral_species")) %>%
  left_join(., threat.interpretation, by = c(`Virus Name` = "viral_species")) %>%
  mutate(country = ifelse(country == !!report_country, NA_character_, country)) %>%
  group_by_at(vars(-country)) %>%
  summarize("Concurrent Detections" = paste(unique(country), collapse = "\n")) %>%
  ungroup() %>%
  mutate(
    `Concurrent Detections` = str_replace(`Concurrent Detections`, "NA\n", ""),
    `Concurrent Detections` = str_replace(`Concurrent Detections`, "\nNA", ""),
    `Known Human Threat?` = ifelse(`Known Human Threat?` == "yes", "yes\n(scroll over for details)", `Known Human Threat?`)
  ) %>%
  rename(`Concurrent Detections\n(Gov. Approved)` = `Concurrent Detections`) %>%
  arrange(`Viral Test Type`, `Virus Name`) %>%
  mutate_at(
    vars(-interpretation),
    cell_spec, format = "html", 
    bold = TRUE, color = text.color
  ) %>%
  mutate(
    `Known Human Threat?` = 
      ifelse(str_detect(`Known Human Threat?`, "yes"), 
             str_replace(`Known Human Threat?`, "<span ", paste("<span data-toggle = 'tooltip' data-placement = 'top' title = '", interpretation, "' ")),
             `Known Human Threat?`)
  ) %>%
  select(-interpretation) %>%
  # kable(escape = FALSE, align = "c") %>%
  # kable_styling(fixed_thead = TRUE)
  datatable(class = "row-border", escape = FALSE, rownames = FALSE, 
            options = list(
              columnDefs = list(list(className = 'dt-center', targets = 0:(dim(.)[2] - 1))),
              pageLength = 5,
              drawCallback = JS("$(function () {$('[data-toggle=\"tooltip\"]').tooltip()})"),
              scrollX = TRUE
            )
  )
```
</div>

#### Viral Testing Heatmap

<button class="btn btn-primary btn-block" type="button" data-toggle="collapse" data-target="#vir-test-heatmap" aria-expanded="false" aria-controls="vir-test-heatmap" color="grey">
    Expand / Collapse
</button>

<div class="collapse" id="vir-test-heatmap">
\newline  
  
Building from the viral summary table above, these heatmaps provides more granular information about sampling effort and detection rates across the five priority PREDICT-2 viral groups: Coronaviruses, Filoviruses, Flaviviruses, Influenzas, and Paramyxoviruses. First, data are summarized at the host genus level, and broader taxonomic groups are shown in parentheses. Next, data are summarized by reported disease transmission interfaces at the sampling sites. Data within the heatmaps show the percentage of viral detections that were confirmed positive (%) and the number of PCR tests conducted (in parentheses). The intensity of red color within the heatmaps scales with viral detection rate. Host taxa or interfaces that never yielded positive viral tests for a given viral group are shown in white, while red coloration indicates increasingly higher rates of viral detection.

```{r heatmaps-prep}

# Country-level heat maps of viral detections by animal group

tests.of.interest <- c("Coronaviruses", "Filoviruses", "Flaviviruses",
                       "Influenzas", "Paramyxoviruses")

tmp1 <- d2 %>%
  mutate(
    family = case_when(
      is.na(family) ~ "Unknown",
      TRUE ~ family
    ),
    genus = case_when(
      is.na(genus) ~ "Unknown",
      TRUE ~ genus
    )
  ) %>%
  filter(
    test_requested %in% tests.of.interest,
    test_type == "Conventional PCR"
  ) %>%
  arrange(gains4_test_id, desc(virus_detected)) %>%
  distinct(gains4_test_id, .keep_all = TRUE) %>%
  group_by(taxa_group_mod, genus, test_requested) %>%
  summarize(
    n_tests = n_distinct(gains4_test_id),
    n_positives = sum(virus_detected, na.rm = TRUE),
    prop = n_positives/n_tests,
    prop.num.for.plot = ifelse(prop == 0, prop, prop + 0.1),
    percent = round(n_positives/n_tests*100, digits = 1),
    percent_mod = paste0(percent, "% (", n_tests, ")")
  ) %>%
  ungroup() %>%
  filter(
    !is.na(taxa_group_mod),
    !is.na(test_requested)
  ) %>%
  arrange(taxa_group_mod, genus) %>%
  mutate(
    genus = paste0(genus, " (", taxa_group_mod, ")"),
    genus = factor(genus, rev(unique(genus)))
  )

tmp1_mod <- distinct(tmp1, genus, taxa_group_mod)

horizontal.breaks <- c()

for(i in unique(tmp1_mod$taxa_group_mod)) {
  
  horizontal.breaks <- 
    c(horizontal.breaks, max(which(tmp1_mod$taxa_group_mod == i)))
}

horizontal.breaks <- horizontal.breaks[horizontal.breaks != nrow(tmp1_mod)]
horizontal.breaks <- nrow(tmp1_mod) - horizontal.breaks
horizontal.breaks <- horizontal.breaks + 0.5

heatmap1 <- tmp1 %>%
  ggplot(aes(
    x = test_requested, 
    y = genus
  )) +
  xlab("Viral Test Type") +
  scale_x_discrete(position = "top") +
  geom_tile(aes(fill = log(1 + prop.num.for.plot)), color = "lightgray") +
  geom_text(aes(label = percent_mod)) +
  geom_hline(yintercept = horizontal.breaks, size = 0.4) +
  scale_fill_gradientn(colors = c("white", "firebrick"), limits = c(0, 0.75)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text.x = element_text(size = 12, face = "bold"),
    axis.title.x = element_text(size = 20),
    text = element_text(size = 12),
    axis.title.y = element_blank()
  )

# Country-level heat maps of viral detections by interface

tmp2 <- d2 %>%
  mutate(
    disease_transmission_interfaces = 
      str_replace(disease_transmission_interfaces, 
                  "dwellings and temporary settlements",
                  "dwellings"),
    disease_transmission_interfaces = 
      str_replace(disease_transmission_interfaces, 
                  "outbreak investigation",
                  "outbreak"),
    disease_transmission_interfaces = 
      str_replace(disease_transmission_interfaces, 
                  "zoos and sanctuaries",
                  "zoos/sanctuaries")
  ) %>%
  filter(
    test_requested %in% tests.of.interest,
    test_type == "Conventional PCR"
  ) %>%
  arrange(gains4_test_id, desc(virus_detected)) %>%
  distinct(gains4_test_id, .keep_all = TRUE) %>%
  group_by(disease_transmission_interfaces, test_requested) %>%
  summarize(
    n_tests = n_distinct(gains4_test_id),
    n_positives = sum(virus_detected, na.rm = TRUE),
    prop = n_positives/n_tests,
    prop.num.for.plot = ifelse(prop == 0, prop, prop + 0.1),
    percent = round(n_positives/n_tests*100, digits = 1),
    percent_mod = paste0(percent, "% (", n_tests, ")")
  ) %>%
  ungroup() %>%
  filter(!is.na(disease_transmission_interfaces)) %>%
  arrange(disease_transmission_interfaces)

# Split up disease transmission interface row labels into two lines if they're long
pos <- str_locate_all(tmp2$disease_transmission_interfaces, ";")
list <- lapply(pos, function(x) ifelse(nrow(x) >= 3, return(x[3, ]), return(c(NA, NA))))
list <- do.call(rbind, list)
for(i in 1:nrow(list)) {
  
  if(!is.na(list[i, 1])) str_sub(tmp2$disease_transmission_interfaces[i], list[i, 1], list[i, 2]) <- ";\n"
}

tmp2 <- tmp2 %>%
   mutate(
    disease_transmission_interfaces = 
      factor(disease_transmission_interfaces, rev(unique(disease_transmission_interfaces)))
  )

heatmap2 <- tmp2 %>%
  ggplot(aes(
    x = test_requested, 
    y = disease_transmission_interfaces
  )) +
  xlab("Viral Test Type") +
  scale_x_discrete(position = "top") +
  geom_tile(aes(fill = log(1 + prop.num.for.plot)), color = "lightgray") +
  geom_text(aes(label = percent_mod)) +
  scale_fill_gradientn(colors = c("white", "firebrick"), limits = c(0, 0.75)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text.x = element_text(size = 12, face = "bold"),
    axis.title.x = element_blank(),
    text = element_text(size = 12),
    axis.title.y = element_blank()
  )

fig.height <- sum(nrow(tmp1) + nrow(tmp2))/16
if(fig.height < 4.5) {fig.height <- 4.5}
```

```{r heatmaps-plot, fig.align = "center", fig.width = 10, fig.height = fig.height}

plot_grid(heatmap1, heatmap2, nrow = 2, align = "v", rel_heights = c(nrow(tmp1), 2*nrow(tmp2)))
```
</div>

#### Site-Level Summary Table

<button class="btn btn-primary btn-block" type="button" data-toggle="collapse" data-target="#site-sum-table" aria-expanded="false" aria-controls="site-sum-table" color="grey">
    Expand / Collapse
</button>

<div class="collapse" id="site-sum-table">
\newline  
  
This table provides a site-level overview of `r report_country` PREDICT-2 viral detections. For each site, the table outlines basic site characteristics as well as a summary of the viruses found and host species that were positive at each site. 

**Please note you may need to scroll horizontally within the table to view all columns.**

```{r tables-2}

get_country_site_viruses2(view = FALSE, animal_virus_summary) %>% 
  mutate_all(
    cell_spec, format = "html", 
    bold = TRUE, color = text.color
  ) %>%
  # kable(escape = FALSE, align = "c") %>%
  # kable_styling(fixed_thead = TRUE) %>%
    datatable(class = "row-border", escape = FALSE, rownames = FALSE, 
            options = list(
              columnDefs = list(list(className = 'dt-center', targets = 0:(dim(.)[2] - 1))),
              pageLength = 5,
              scrollX = TRUE
            )
  )
```
</div>

#### Concurrent Site-Level Summary Table

<button class="btn btn-primary btn-block" type="button" data-toggle="collapse" data-target="#con-site-sum-table" aria-expanded="false" aria-controls="con-site-sum-table" color="grey">
    Expand / Collapse
</button>

<div class="collapse" id="con-site-sum-table">
\newline  

This table provides a site-level overview of `r report_country` PREDICT-2 viral detections, considering only the concurrent sampling sites. For each concurrent site, the table shows the human density impact levels recorded as well as a summary of the viruses found and host species that were positive. 

**Please note you may need to scroll horizontally within the table to view all columns.**

```{r tables-3}

get_country_site_viruses2_concurrent(view = FALSE, animal_virus_summary) %>% 
  mutate_all(
    cell_spec, format = "html", 
    bold = TRUE, color = text.color
  ) %>%
  # kable(escape = FALSE, align = "c") %>%
  # kable_styling(fixed_thead = TRUE) %>%
    datatable(class = "row-border", escape = FALSE, rownames = FALSE, 
            options = list(
              columnDefs = list(list(className = 'dt-center', targets = 0:(dim(.)[2] - 1))),
              pageLength = 5,
              scrollX = TRUE
            )
  )
```
</div>

#### Host-Level Summary Table

<button class="btn btn-primary btn-block" type="button" data-toggle="collapse" data-target="#host-sum-table" aria-expanded="false" aria-controls="host-sum-table" color="grey">
    Expand / Collapse
</button>

<div class="collapse" id="host-sum-table">
\newline  

This table provides a host-level overview of `r report_country` PREDICT-2 viral detections. For each host species (or the lowest level taxonomic categorization known), the table provides the unique viruses discovered in-country and the sites where viral detection occurred.

```{r tables-4}

host.table <- animal_virus_summary %>%
  group_by(species_scientific_name, taxa_group_mod) %>%
  summarize(
    n_viruses = length(unique(viral_species)),
    viruses = paste(sort(unique(viral_species)), collapse = "\n"),
    n_detections = sum(n_positives),
    sites = paste(sort(unique(site_name)), collapse = "\n")
  ) %>%
  ungroup()

colnames(host.table) <- c("Species", "Taxa Group", "Unique Viruses",
                          "Virus Names", "No. Detections", "Site Name")

host.table %>%
  mutate_all(
    cell_spec, format = "html", 
    bold = TRUE, color = text.color
  ) %>%
  datatable(class = "row-border", escape = FALSE, rownames = FALSE, 
            options = list(
              columnDefs = list(list(className = 'dt-center', targets = 0:(dim(.)[2] - 1))),
              pageLength = 10
            )
  )
```
</div>

#### Viral Findings in Major Host Groups

<button class="btn btn-primary btn-block" type="button" data-toggle="collapse" data-target="#host-findings-plot" aria-expanded="false" aria-controls="host-findings-plot" color="grey">
    Expand / Collapse
</button>

<div class="collapse" id="host-findings-plot">
\newline  

This figure summarizes viral detections across four major host taxonomic groups, where applicable in-country: bats, birds, non-human primates, and rodents/shrews. 

```{r viral-findings-by-taxa, fig.align = "center", fig.height = 8, fig.width = 12}

axis.title.size <- 22
axis.text.size <- 20
legend.text.size <- 20

tmp <- animal_virus_summary %>%
  mutate(
    test_requested = case_when(
      test_requested == "Nipah Viruses" ~ "Paramyxoviruses",
      test_requested == "other-Influenza A" ~ "Influenzas",
      TRUE ~ test_requested
    )
  ) %>%
  filter(taxa_group_mod %in% c("bats", "birds", "non-human primates", "rodents/shrews")) %>%
  group_by(test_requested, taxa_group_mod) %>%
  summarize(n_viral_species = n_distinct(viral_species))

y.max <- ceiling(max(tmp$n_viral_species)/5)*5

if(nrow(tmp) > 0) {
  
  tmp %>%
    ggplot(aes(x = test_requested, y = n_viral_species, fill = taxa_group_mod)) +
    geom_bar(stat = "identity", position = "dodge") +
    ylab("Number of unique viruses detected") +
    ylim(0, y.max) +
    scale_fill_manual(values = cb_palette[c(1, 2, 4, 5)]) +
    theme_minimal() +
    theme(axis.title = element_text(size = axis.title.size),
          axis.title.x = element_blank(),
          axis.text = element_text(size = axis.text.size),
          axis.text.x = element_text(size = axis.text.size - 4, face = "bold"),
          legend.title = element_blank(),
          legend.text = element_text(size = legend.text.size),
          legend.position = "bottom")
} else {
  
  ggplot(data.frame(cbind(x = 1, y = 1)), aes(x = x, y = y)) + 
    geom_text(label = "No relevant data", size = 20) +
    theme_minimal() +
    theme(axis.title = element_blank(),
          axis.text = element_blank(),
          panel.grid = element_blank())
}
```
</div>

```{r viral-host-range-prep, include = FALSE}

viral.name.harmonization <- read_csv(h("data", "hp3_to_p2_viral_name_harmonization.csv"))

all_equal(
  grep("PREDICT", sort(unique(t2$viral_species)), invert = TRUE, value = TRUE), 
  viral.name.harmonization$p2_virus_name
)

hp3.associations <- read_csv(h("data", "associations.csv")) %>%
  rename(
    virus_name = vVirusNameCorrected,
    host_name = hHostNameFinal
  ) %>%
  left_join(., viral.name.harmonization, by = c("virus_name" = "hp3_virus_name")) %>%
  filter(!is.na(p2_virus_name)) %>%
  mutate(
    viral_species = p2_virus_name,
    species_scientific_name = str_replace_all(host_name, "_", " "),
    project = rep("Previously known", nrow(.))
  )

# "species" to exclude from P2 associations

p2.associations <- read_csv(h("data", "P2_virus_mammal_host_associations.csv")) %>%
  filter(viral_species %in% unique(hp3.associations$viral_species)) %>%
  group_by(viral_species, species_scientific_name) %>%
  summarize(country_list = glue_collapse(country, sep = ", ")) %>%
  mutate(
    project = case_when(
      str_detect(country_list, report_country) & str_detect(country_list, ",") ~ paste("P2", report_country, "and partners"),
      str_detect(country_list, report_country) ~ paste("P2", report_country),
      TRUE ~ "P2 partners"
    )
  ) %>%
  select(-country_list)

viruses.in.country <- p2.associations %>%
  filter(str_detect(project, report_country)) %>%
  pull(viral_species) %>%
  unique()

p2.associations <- filter(p2.associations, viral_species %in% viruses.in.country)

full.association.table <- hp3.associations %>%
  select(viral_species, species_scientific_name, project) %>%
  filter(viral_species %in% viruses.in.country) %>%
  bind_rows(., p2.associations) %>%
  arrange(viral_species, species_scientific_name, desc(project)) %>%
  distinct(viral_species, species_scientific_name, .keep_all = TRUE) %>%
  mutate(
    project = factor(project, levels = c(paste("P2", report_country), 
                                         paste("P2", report_country, "and partners"), 
                                         "P2 partners", 
                                         "Previously known"))
  )

viruses.to.keep <- full.association.table %>%
  group_by(viral_species) %>%
  summarize(project = glue_collapse(project, sep = ", ")) %>%
  filter(str_detect(project, "P2")) %>%
  pull(viral_species) %>%
  unique()

full.association.table <- filter(full.association.table, viral_species %in% viruses.to.keep)
```

#### Expansion of Known Virus Host Range

<button class="btn btn-primary btn-block" type="button" data-toggle="collapse" data-target="#vir-range-fig" aria-expanded="false" aria-controls="vir-range-fig" color="grey">
    Expand / Collapse
</button>

<div class="collapse" id="vir-range-fig">
\newline  
  
This table shows the expansion in the number of recognized mammal host species for previously-described viruses as a result of `r report_country` PREDICT-2 sampling. One bar is shown for each previously-described (known) virus, i.e. those named by the International Committee on the Taxonomy of Viruses 8th edition. Previously known host species for each virus are from the dataset of [Olival et al. 2017](https://www.nature.com/articles/nature22975). The number of mammalian hosts for each virus are visualized using stacked bar plots, showing the number of pre-PREDICT-2 recognized host species (gray portion), the number of *newly recognized host species* found by PREDICT-2 `r report_country` (orange portion), and, where applicable, the number of *newly recognized host species* found in both PREDICT-2 `r report_country` and other PREDICT-2 country sampling efforts (green portion) and the number of *newly recognized host species* found in other PREDICT-2 countries. Only previously-described viruses for which PREDICT-2 `r report_country` reported new host species are shown.

```{r viral-host-range, fig.align = "center", fig.height = 8, fig.width = 12}

axis.title.size <- 22
axis.text.size <- 18
legend.text.size <- 20
template.colors <- cb_palette[c(1, 2, 5, 3)]
plot.colors <- if(sum(str_detect(full.association.table$project, " and ")) > 0) {
  template.colors
} else {
  template.colors[c(1, 3, 4)]
}

if(nrow(full.association.table) > 0) {
  
  full.association.table %>%
  mutate(viral_species = str_replace(viral_species, " \\(", "\n\\(")) %>%
  ggplot(aes(x = viral_species, fill = project)) +
  ylab("Number of known host species") +
  geom_bar() +
  scale_fill_manual(values = plot.colors) +
  theme_minimal() +
  theme(axis.title = element_text(size = axis.title.size),
        axis.title.x = element_blank(),
        axis.text = element_text(size = axis.text.size),
        axis.text.x = element_text(size = axis.text.size - 4, face = "bold"),
        legend.title = element_blank(),
        legend.text = element_text(size = legend.text.size),
        legend.position = "bottom")
} else {
  
  ggplot(data.frame(cbind(x = 1, y = 1)), aes(x = x, y = y)) + 
    geom_text(label = "No relevant data", size = 20) +
    theme_minimal() +
    theme(axis.title = element_blank(),
          axis.text = element_blank(),
          panel.grid = element_blank())
}

```
</div>

```{r viral-curves-prep, include = FALSE}

# Define the viral test types and specific protocols of interest

tests.of.interest <- c("Coronaviruses", "Filoviruses", 
                       "Flaviviruses", "Paramyxoviruses")

protocols.of.interest <- c(
  "Modified Watanabe et al, RdRp gene",
  "Unpublished, UCD",
  "Moureau et al, NS5 gene",
  "Tong et al, PAR"
)

# Recover all specimens for which a viral test type of interest was conducted
# using the specified protocol of interest

specimens <- d2 %>%
  filter(
    test_requested %in% tests.of.interest,
    test_requested_protocol %in% protocols.of.interest
  ) %>%
  group_by(specimen_id, test_requested) %>%
  summarize(
    n = n(),
    n_tests = n_distinct(gains4_test_id),
    tests = glue_collapse(unique(test_requested), sep = ","),
    test_protocols = glue_collapse(unique(test_requested_protocol, sep = ","))
  ) %>%
  filter(
    n_tests == 1
  ) %>%
  pull(specimen_id)

# Create a data subset for viral curves plotting that contains only the
# specimens of interest for the viral test types of interest

d.subset <- d2 %>%
  filter(
    test_requested %in% tests.of.interest,
    test_requested_protocol %in% protocols.of.interest,
    specimen_id %in% specimens
  )

assertthat::assert_that(n_distinct(d.subset$specimen_id) == length(unique(specimens)))

# Create iNEXT objects

i.list <- create_ilist(d.subset, "test_requested", "specimen_id")
if(length(i.list) == 1) {x <- as.matrix(i.list[[1]])}
if(length(i.list) > 1) {x <- i.list}
if(length(i.list) > 0) {i.out <- iNEXT(x, q = 0, datatype = "incidence_raw")}
```

#### Viral Discovery Curves

<button class="btn btn-primary btn-block" type="button" data-toggle="collapse" data-target="#vir-disc-curves" aria-expanded="false" aria-controls="vir-disc-curves" color="grey">
    Expand / Collapse
</button>

<div class="collapse" id="vir-disc-curves">
\newline  
  
To provide model-based estimates of viral sampling completeness within country, here we generate viral discovery curves across four of the five priority PREDICT-2 viral groups. We have excluded influenza testing from this analysis since only one influenza species (Influenza A) was recovered globally in PREDICT-2. In order to preserve interpretability among curves, we have restricted the data included in this portion of the report. Specifically, we report only on specimens that were tested for the same viral test protocol within each viral test type. The viral test protocols considered here are: `r glue_collapse(paste0(protocols.of.interest, " (", tests.of.interest, ")"), sep = "; ")`. Thus, every specimen included in the figure was tested only once, with the viral test protocol indicated, for each viral test type. **Critically, this analysis should only be interpreted as projected viral diversity _given the particular geographic locations, host species, and testing procedures considered by PREDICT-2 `r report_country`._** Remaining viral diversity to be discovered in-country may be greater if future viral surveillance efforts expand to include other regions, animal taxa, and/or testing methods.

```{r, viral-curves-plot, fig.align = "center", fig.height = 6, fig.width = 8}

if(length(i.list) > 0) {
  
  # Set plot characteristics and plot the iNEXT results
  
  axis.title.size <- 28
  axis.text.size <- 22
  legend.text.size <- 22
  template.colors <- cb_palette[c(1:3, 5)]
  plot.colors <- template.colors[tests.of.interest %in% names(i.list)]
  
  ggiNEXT(i.out) +
    xlab("Number of specimens") + ylab("Viral diversity") +
    scale_color_manual(values = plot.colors, labels = names(i.list)) +
    scale_fill_manual(values = plot.colors, labels = names(i.list)) +
    scale_shape_manual(values = rep(19, length(i.list)), labels = names(i.list)) +
    guides(linetype = F) +
    theme_minimal() +
    theme(axis.title = element_text(size = axis.title.size),
          axis.text = element_text(size = axis.text.size),
          legend.title = element_blank(),
          legend.text = element_text(size = legend.text.size),
          legend.position = "bottom")
} else {
  
  ggplot(data.frame(cbind(x = 1, y = 1)), aes(x = x, y = y)) + 
    geom_text(label = "No relevant data", size = 20) +
    theme_minimal() +
    theme(axis.title = element_blank(),
          axis.text = element_blank(),
          panel.grid = element_blank())
}
```
</div>

### Section 2: Viral Host Ranges and Risk Maps

The map below communicates two layers of information:

1) Human and livestock population density in `r report_country`.

2) Ranges of mammal host species in which viruses have been detected in `r report_country` under PREDICT surveillance.

**To control the layers visible on the map, click the bottom left icon.**  

-   This will bring up a list of viruses that have been detected in mammals in `r report_country`. Click on a virus to see global ranges from the International Union for Conservation of Nature (IUCN) for the host species positive for that virus. Hover your cursor over geographic ranges to see the host species names. Points (circles) on the map show where host species were sampled in `r report_country`. Solid color circles indicate that the virus was detected in one or more animals; circles filled with white indicate the virus was not detected. Hover over points to see counts of animals tested at each site.

-   At the bottom of the list, you can select whether to show the human population density map or the livestock density map, or you can turn off both maps to more easily view the viral host range layers. The human population density layer is estimated by the Center for International Earth Science Information Network (CIESIN), and the mammalian livestock density layer is based on a model developed by [Robinson et al. 2014](http://dx.doi.org/10.1371/journal.pone.0096084).

-   Note that EcoHealth Alliance PREDICT-2 countries are outlined on the map in white.

**For easier viewing, you may use the icon on the top right to launch full-screen mode.**    

```{r get-map-data, include=FALSE}

# Get administrative borders of countries of interest
country_mod <-  mod_country(report_country) # for density rasters
country_eha <-  mod_country(eidith::eha_countries()) %>% unique() # for range layers

admin <- ne_countries(country = country_mod, type='countries', scale = 'large')
admin_eha <- ne_countries(country = country_eha, type='countries', scale = 'large')

# Centroids for setting view in leaflet
country_centroid <- CoordinateCleaner::countryref %>% 
  filter(name == countrycode(sourcevar = country_mod,
                             origin = "country.name",
                             destination = "country.name")) %>%
  slice(1)

# Get population density rasters
human_dens <- get_layers("gpw-v4-population-density_2015.tif", admin)
mammal_dens <- get_layers("summed_mammal_livestock.tif", admin)

# Get iucn ranges for species with viral detections
iucn <- st_read(h("data", "TERRESTRIAL_MAMMALS")) %>% # downloaded: https://www.iucnredlist.org/resources/spatial-data-download
  filter(presence == 1) %>%
  mutate(
    binomial = case_when(
      binomial == "Rattus arfakienis" ~ "Rattus arfakiensis",
      str_detect(binomial, "Oryx beisa ssp") ~ "Oryx beisa",
      TRUE ~ as.character(binomial)
    )
  )

iucn <- iucn %>%
  left_join(., read_csv(h("data", "iucn_to_hp3_taxonomic_harmonization.csv")),
            by = c("binomial" = "IUCN_name")) %>%
  mutate(binomial = ifelse(!is.na(hp3_zoo_prediction_name), hp3_zoo_prediction_name, binomial))

# Viral-species pairs
animal_viral_pairs <- read_csv(h("data", "viral_species_testing_by_host_and_site.csv")) %>%
  filter(country == !!report_country,
         species_scientific_name %in% unique(iucn$binomial)) # only keep host species that have ranges

viral.species.detected.in.country <- animal_viral_pairs %>% # identify specues with detects
  filter(n_animals_w_detections > 0) %>%
  pull(viral_species) %>%
  unique()

animal_viral_pairs <- filter(animal_viral_pairs, viral_species %in% viral.species.detected.in.country)
```

<style>
.leaflet {
    margin: auto;
}
</style>

```{r maps, fig.align = "center"}

# set palettes
max_val_human <- ceiling(maxValue(human_dens))
pal_human <- colorBin(palette =
                        c("white","gray50", "black"),
                      #c("azure4", "yellow", "coral2"),
                      #c("mistyrose1", "coral", "darkred"),
                      domain = -1:max_val_human, na.color = "transparent")

max_val_mammal <- ceiling(maxValue(mammal_dens))
min_val_mammal <- floor(minValue(mammal_dens))
pal_mammal <- colorBin( c("white","gray50", "black"),
                        #palette = c("azure4", "yellow", "coral2"), 
                        domain = min_val_mammal:max_val_mammal, 
                        na.color = "transparent", pretty = TRUE, 
                        bins = 5)

opac <- 0.3
rad <- 5

# initiate leaflet map
lf <- leaflet() %>%
  addProviderTiles("CartoDB.DarkMatter") %>%
  addPolygons(data = admin_eha, fill = FALSE, stroke = TRUE, weight = 1, color = "white", opacity = 0.5) %>% # EHA outlines
  addFullscreenControl(position = "topright")

for(vir in viral.species.detected.in.country) {
  
  species_detects <- animal_viral_pairs %>%
    filter(
      viral_species == vir, 
      n_animals_w_detections > 0
    ) 
  
  species <- unique(species_detects$species_scientific_name)
  
  species_non_detects <- animal_viral_pairs %>%
    filter(
      viral_species == vir, 
      n_animals_w_detections == 0
    )
  
  pal_spec <- suppressWarnings(brewer.pal(length(species), "Set3"))
  
  if(length(species) < 11) {
    
    names(pal_spec) <- species
    
    for(spec in species) {
      
      iucn_sub <- iucn %>% filter(binomial==spec)
      
      lf <- lf %>%
        addPolygons(data = iucn_sub,
                    stroke = TRUE, color = unname(pal_spec[spec]), weight = 2, opacity = opac,
                    fill = TRUE, fillColor = unname(pal_spec[spec]), fillOpacity = opac,
                    label = spec,
                    group = vir) 
    }
    
    lf <- lf %>%
      addCircleMarkers(data = species_non_detects, radius = rad,
                       lng = ~jitter(site_longitude), lat = ~jitter(site_latitude), 
                       stroke = TRUE, color = ~unname(pal_spec[species_scientific_name]), weight = 1.5, opacity = 1,
                       fill = TRUE, fillColor = "#ffffff", fillOpacity = 1,
                       label = ~paste0("PREDICT ", species_scientific_name, " non-detect (", n_animals_tested, " animals tested)"),
                       group = vir) %>%
            addCircleMarkers(data = species_detects, radius = rad, 
                       lng = ~jitter(site_longitude), lat = ~jitter(site_latitude), 
                       stroke = FALSE, 
                       fill = TRUE, fillColor = ~unname(pal_spec[species_scientific_name]), fillOpacity = 1,
                       label = ~paste0("PREDICT ", species_scientific_name, " (", n_animals_tested, " animals tested, ", n_animals_w_detections, " animals positive)"),
                       group = vir) 

    
  } else { # n species > 10
    
    iucn_sub <- iucn %>% filter(binomial %in% species)
    
    lf <- lf %>%
      addPolygons(data = iucn_sub,
                  stroke = TRUE, color = "#7FC97F", weight = 2, opacity = opac,
                  fill = TRUE, fillColor = "#7FC97F", fillOpacity = opac,
                  label = htmltools::HTML(glue_collapse(species, "<br/>")),
                  group = vir) %>%
          addCircleMarkers(data = species_non_detects, radius = rad,
                       lng = ~jitter(site_longitude), lat = ~jitter(site_latitude), 
                       stroke = TRUE, color =  "#7FC97F", weight = 1.5, opacity = 1,
                       fill = TRUE, fillColor = "#ffffff", fillOpacity = 1,
                       label = ~paste0("PREDICT ", species_scientific_name, " non-detect (", n_animals_tested, " animals tested)"),
                       group = vir) %>%
            addCircleMarkers(data = species_detects, radius = rad, 
                       lng = ~jitter(site_longitude), lat = ~jitter(site_latitude), 
                       stroke = FALSE, 
                       fill = TRUE, fillColor = "#7FC97F", fillOpacity = 1,
                       label = ~paste0("PREDICT ", species_scientific_name, " (", n_animals_tested, " animals tested, ", n_animals_w_detections, " animals positive)"),
                       group = vir) 
    
  }
}

lf <- lf %>%
  # Human
  addRasterImage(x = human_dens, colors = pal_human, group = "Human", opacity = 1) %>%
  addLegend(pal = pal_human, values = values(human_dens), group = "Human", position = "bottomright",
            title =  "Human Population Density <br/> (Persons per Sq. Km)", 
            labFormat = labelFormat(digits = 0 ,transform = function(x) 10 ^ x)) %>%
  # Mammals
  addRasterImage(x = mammal_dens, colors = pal_mammal, opacity = 0.8, group = "Mammal") %>%
  addLegend(pal = pal_mammal, values = values(mammal_dens), group = "Mammal", position = "bottomright",
            title = "Mammal Livestock Density <br/> (Head per Sq. Km)" , labFormat = labelFormat(digits = 0)) %>%
  # User controlled layers
  addLayersControl(
    overlayGroups  = c("Human", "Mammal"), #  legend group only works when using overlayGroups
    baseGroups = c("None", sort(viral.species.detected.in.country)),
    options = layersControlOptions(collapsed = TRUE),
    position = "bottomleft"
  )  %>%
  hideGroup("Mammal") %>%
  setView(zoom = 3, lng = country_centroid$centroid.lon, lat = country_centroid$centroid.lat)

lf

```

### Section 3: Prioritization of Future Viral Discovery and Zoonotic Surveillance

```{r, missing-zoonoses-analysis-prep, include = FALSE}

mz <- read_csv(h("data", "hp3_zoo_predictions.csv")) %>%
  mutate(
    species = case_when(
      species == "Rattus_arfakienis" ~ "Rattus arfakiensis",
      TRUE ~ str_replace(species, "_", " ")
    )
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  filter(species != "Pteropus pelewensis ssp. yapensis") %>%
  left_join(., read_csv(h("data", "hp3_taxonomy_harmonization.csv")), by = "species") %>%
  mutate(species = 
           ifelse(!is.na(species_alt), 
                  paste0(species, "|", species_alt),
                  species)
  ) %>%
  separate_rows(species, sep = "\\|") %>%
  select(-species_alt) %>%
  arrange(desc(pred_mean)) %>%
  mutate(
    relative_zoonoses = case_when(
      pred_mean > quantile(pred_mean, 0.9) ~ "Top 10% of all mammals",
      pred_mean > quantile(pred_mean, 0.8) ~ "Top 20% of all mammals",
      pred_mean > quantile(pred_mean, 0.7) ~ "Top 30% of all mammals",
      pred_mean > quantile(pred_mean, 0.6) ~ "Top 40% of all mammals",
      pred_mean > quantile(pred_mean, 0.5) ~ "Top 50% of all mammals",
      pred_mean > quantile(pred_mean, 0.4) ~ "Bottom 50% of all mammals",
      pred_mean > quantile(pred_mean, 0.3) ~ "Bottom 40% of all mammals",
      pred_mean > quantile(pred_mean, 0.2) ~ "Bottom 30% of all mammals",
      pred_mean > quantile(pred_mean, 0.1) ~ "Bottom 20% of all mammals",
      pred_mean > quantile(pred_mean, 0) ~ "Bottom 10% of all mammals"
    )
  )

mammals.in.country <- read_csv(h("data", "mammal_country_lookup.csv")) %>%
  filter(country == !!report_country) %>%
  pull(binomial)

mz.subset <- filter(mz, species %in% mammals.in.country)

species.sampled.in.country <- d2 %>%
  mutate(species_scientific_name = word(species_scientific_name, 1, 2)) %>%
  pull(species_scientific_name) %>%
  unique()

text.color <- ifelse(mz.subset$species %in% species.sampled.in.country, "#1B8925", "#BD0505")

specimen.count <- d2 %>%
  mutate(species_scientific_name = word(species_scientific_name, 1, 2)) %>%
  group_by(species_scientific_name) %>%
  summarize(
    specimen_count = n_distinct(specimen_id, na.rm = T),
    virus_count = n_distinct(viral_species, na.rm = T),
    viruses_detected = ifelse(virus_count > 0, "Yes", "No")
  )

assertthat::assert_that(length(species.sampled.in.country) == nrow(specimen.count))

mz.subset <- left_join(mz.subset, specimen.count, by = c("species" = "species_scientific_name"))
```

#### Host Sampling Prioritization Based on Predicted "Missing" Zoonoses

<button class="btn btn-primary btn-block" type="button" data-toggle="collapse" data-target="#miss-zoo" aria-expanded="false" aria-controls="miss-zoo" color="grey">
    Expand / Collapse
</button>

<div class="collapse" id="miss-zoo">
\newline  
  
To help prioritize future viral surveillance in-country, we draw on the modeling work of [Olival et al. 2017](https://www.nature.com/articles/nature22975). This PREDICT-funded study used a suite of mammal host traits to predict the as-of-yet undiscovered (or "missing") viral diversity in mammals. We extended a version of the "missing zoonoses" model from that paper to all mammals and rank all mammal species based on their probability of harboring unknown zoonoses. Below we list all mammal species occurring in `r report_country` and rank them based on model-based estimates of the number of predicted unobserved zoonotic viruses. We have converted these quantitative estimates into broad risk categories here to simplify surveillance prioritization and interpretation. Host species already sampled in PREDICT-2 `r report_country` are indicated in green, along with the number of specimens collected from that species. Host species not yet sampled in `r report_country` under PREDICT-2 efforts, and therefore of possible interest for future viral surveillance work, are highlighted in red.

```{r, missing-zoonoses-analysis}

mz.subset %>% 
  select(1, 9, 10, 12) %>%
  mutate(
    specimen_count = ifelse(is.na(specimen_count), 0, specimen_count),
    viruses_detected = ifelse(is.na(viruses_detected), "", viruses_detected)) %>%
  mutate_at(
    vars(species),
    cell_spec, format = "html", 
    bold = TRUE, color = text.color
  ) %>%
  mutate_at(
    vars(-species),
    cell_spec, format = "html", 
    bold = TRUE, color = "#787272"
  ) %>%
  rename(
    `Host Species` = species,
    `Predicted No. of Unobserved Zoonotic Viruses` = relative_zoonoses,
    `No. of Specimens Collected` = specimen_count,
    `Viruses Detected In-Country?` = viruses_detected
  ) %>%
  # kable(escape = FALSE, align = "c") %>%
  # kable_styling(fixed_thead = TRUE) %>%
    datatable(class = "row-border", escape = FALSE, rownames = FALSE, 
            options = list(
              columnDefs = list(list(className = 'dt-center', targets = 0:(dim(.)[2] - 1))),
              pageLength = 20
            )
  )
```
</div>

#### Geographic Sampling Prioritization Based on Global Virome Project Spatial Analyses

<button class="btn btn-primary btn-block" type="button" data-toggle="collapse" data-target="#gvp" aria-expanded="false" aria-controls="gvp" color="grey">
    Expand / Collapse
</button>

<div class="collapse" id="gvp">
\newline  

The [Global Virome Project](https://www.globalviromeproject.org/) aims to build a comprehensive viral database and identify zoonotic viruses with the greatest potential to infect humans in hopes of ultimately reducing the likelihood of viral spillover events. This map shows viral sampling priority areas in `r report_country`, ranked from most optimal (white) to least optimal (dark blue). We used the Zonation Conservation Planning Software to select and rank sites of highest sampling value based on the number of unique zoonotic viruses predicted to occupy each grid cell (derived from [Olival et al. 2017](https://www.nature.com/articles/nature22975)) and the relative cost of accessing each site from nearby cities of greater than 50,000 people ([Weiss et al. 2018](https://www.nature.com/articles/nature25181)). We identified optimal areas for viral sampling using a decision support system for spatial planning that allocates resources (e.g. sampling costs) and prioritizes areas. The result is a ranking of all potential sampling sites in `r report_country` based on the highest return on investment for sampling in a particular area.

```{r, gvp-maps, fig.align = "center", out.width = "600px"}

gvp.filename <- read_csv(h("data", "country_GVP_map_lookup.csv")) %>%
  filter(country == report_country) %>%
  pull(gvp_filename)

gvp.filename.full <- h("data", "predictGVPmaps", gvp.filename)

if(!is.na(gvp.filename)) {
  
  knitr::include_graphics(gvp.filename.full)
} else {
  
  ggplot(data.frame(cbind(x = 1, y = 1)), aes(x = x, y = y)) + 
    geom_text(label = "No relevant data", size = 20) +
    theme_minimal() +
    theme(axis.title = element_blank(),
          axis.text = element_blank(),
          panel.grid = element_blank())
}
```
</div>

# References

Center for International Earth Science Information Network - CIESIN - Columbia University. 2016. Gridded Population of the World, Version 4 (GPWv4): Population Density. Palisades, NY: NASA Socioeconomic Data and Applications Center (SEDAC). http://dx.doi.org/10.7927/H4NP22DQ. Accessed 21 December 2017.

IUCN v6.2. The IUCN Red List of Threatened Species. Version 6.2. http://www.iucnredlist.org. Downloaded on 24 July 2019.

Olival, K.J. *et al.* 2017. Host and viral traits predict zoonotic spillover from mammals. Nature 546: 646-650. http://dx.doi.org/10.1038/nature22975

Robinson, T.P. *et al.* 2014. Mapping the global distribution of livestock. PLoS ONE 9: e96084. http://dx.doi.org/10.1371/journal.pone.0096084

Weiss, D.J. *et al.* 2018. A global map of travel time to cities to assess inequalities in accessibility in 2015. Nature 553: 333-336. http://dx.doi.org/10.1038/nature25181
