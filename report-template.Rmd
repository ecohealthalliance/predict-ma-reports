---
params:
  country: "Thailand"
title: 'PREDICT M&A Report: `r params$country`'
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(CoordinateCleaner)
library(countrycode)
library(DT)
library(eidith)
library(glue)
library(iNEXT)
library(kableExtra)
library(leaflet)
library(leaflet.extras)
library(raster)
library(RColorBrewer)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(tidyverse)
library(wesanderson)
h <- here::here
walk(list.files(h("R/"), full.names = TRUE),
     source, echo = FALSE, verbose = FALSE)
country <- params$country
```

![](./media/predict-logos.png){width="100%"}

#### _Click on the_ ▶ _︎arrows to expand sections._

```{r read-data, include = FALSE}

# Load EIDITH data tables

e <- ed_events() %>% 
  filter(country == !!params$country) # events filtered to country
a <- ed_animals()
s <- ed_specimens()
t <- ed_tests()
v <- ed_viruses()
ts <- ed_testspecimen()

e2 <- ed2_events() %>%
  mutate(country = ifelse(country %in% c("Malaysia, Peninsular", "Malaysia, Sabah"), "Malaysia", country)) %>%
  filter(country == !!params$country) %>% # events filtered to country
  arrange(desc(integer_id)) %>%
  distinct(event_name, .keep_all = TRUE)
a2 <- ed2_animals() %>% 
  select(-c(integer_id, gains4_event_id, gains4_sample_unit_id))
s2 <- ed2_specimens() %>% 
  select(-c(integer_id, gains4_sample_unit_id))
t2 <- ed2_tests() %>%
  select(-c(integer_id))
ti <- ed2_test_interpreted() %>%
  arrange(desc(integer_id)) %>%
  distinct(gains4_test_id, .keep_all = TRUE) %>%
  select(
    -c(integer_id, is_outbreak_testing, season,
       lab_name, real_time_positive_control_value_1, real_time_positive_control_value_2,
       real_time_internal_control_value, real_time_ct_value, lab_name_confirmation,
       test_status, date_govt_approved_release)
  )

# Modify animal taxonomy information

a2 <- a2 %>%
  mutate(
    class = stringr::str_to_sentence(class),
    order = stringr::str_to_sentence(order),
    family = stringr::str_to_sentence(family),
    taxa_group_mod = case_when(
      taxa_group == "cats" ~ "carnivores",
      taxa_group == "dogs" ~ "carnivores",
      taxa_group == "poultry/other fowl" ~ "birds",
      family == "Sciuridae" ~ "rodents/shrews",
      TRUE ~ taxa_group
    ),
    species_scientific_name = case_when(
      species_scientific_name == "Syncerus Caffer" ~ "Syncerus caffer",
      TRUE ~ species_scientific_name
    )
  )

# Split out P2 viral co-infection data

t2 <- t2 %>%
  mutate(
    sequence = case_when(
      str_detect(sequence, "\\|") & !(str_detect(virus, "\\|")) ~ 
        str_replace(sequence, "\\|", ";"),
      str_detect(sequence, "\\|") & is.na(virus) ~ 
        str_replace(sequence, "\\|", ";"),
      TRUE ~ sequence
    )
  )

t2 <- separate_rows(t2, virus, sequence, sep = "\\|")

# Modify virus name (in new "viral_species" column) and detection data

v <- v %>%
  mutate(viral_species = stringi::stri_replace_first_regex(
    virus_name, "(new\\s)?strain\\sof\\s", ""))

t2 <- t2 %>%
  mutate(
    virus = case_when(
      virus == "" ~ NA_character_,
      TRUE ~ virus
    ),
    viral_species = stringi::stri_replace_first_regex(virus, "(new\\s)?strain\\sof\\s", ""),
    viral_species = ifelse(str_detect(viral_species, "(OC43)"), "Betacoronavirus 1 (OC43)", viral_species),
    viral_species = ifelse(str_detect(viral_species, "MJ/67C"), "Hipposideros bat alphacoronavirus MJ/67C", viral_species),
    viral_species = str_replace(viral_species, "Bat Coronavirus", "Bat coronavirus"),
    viral_species = str_replace(viral_species, " Bat ", " bat "),
    virus_detected = ifelse(confirmation_result == "Positive", 1, 0)
  ) %>%
  left_join(., read_csv(h("data", "viral_species_modifications.csv")), by = "viral_species") %>%
  mutate(viral_species = ifelse(!is.na(viral_species_mod), viral_species_mod, viral_species)) %>%
  select(-viral_species_mod)

# Join across all tables to get complete data

d <- left_join(e, a, by = "event_id") %>%
  left_join(s, by = "animal_id") %>%
  left_join(ts, by = "specimen_id") %>%
  left_join(t, by = "test_id") %>%
  left_join(v, by = "test_id")

d2 <- left_join(e2, a2, by = c("event_name", "project")) %>%
  left_join(s2, by = c("animal_id" = "animal_human_id", "project")) %>%
  left_join(t2, by = c("specimen_id", "gains4_specimen_id", "project")) %>%
  left_join(ti, by = c("gains4_specimen_id", "gains4_test_id", "project"))
```

### Section 1: Summary of Viral Findings

<details>
<summary>Virus-Level Summary Table</summary>

This table provides an overview of all in-country viral findings. For each unique virus detected, the table indicates the number of detections, the host taxa in which these detections occurred, and the sites associated with viral detection. Finally, to add broader context to viral findings, the final column of the table lists other PREDICT-2 countries in which the same virus was found, highlighting the potential geographic range of the pathogen.

```{r tables-1}

animal.grouping.vars <-
  c("country", "concurrent_sampling_site", "site_name",
    "human_density_impact", "taxa_group_mod", 
    "species_scientific_name", "viral_species")

animal_virus_summary <- d2 %>%
  filter(!is.na(viral_species)) %>%
  mutate(
    species_scientific_name = case_when(
      str_detect(species_scientific_name, " cf. ") ~ 
        str_replace(species_scientific_name, " cf. ", " "),
      TRUE ~ species_scientific_name
    )
  ) %>%
  group_by_at(vars(one_of(animal.grouping.vars))) %>%
  summarize(n_positives = sum(virus_detected)) %>%
  ungroup() %>%
  arrange(country, site_name, taxa_group_mod, 
          species_scientific_name, viral_species, n_positives)

text.color <- "#787272"

get_country_viruses(view = FALSE, animal_virus_summary) %>%
  left_join(., read_csv(h("data", "viral_species_country_lookup.csv")), 
            by = c(`Virus Name` = "viral_species")) %>%
  mutate(country = ifelse(country == params$country, NA_character_, country)) %>%
  group_by_at(vars(-country)) %>%
  summarize("Concurrent Detections" = paste(unique(country), collapse = "\n")) %>%
  ungroup() %>%
  mutate(
    `Concurrent Detections` = str_replace(`Concurrent Detections`, "NA\n", ""),
    `Concurrent Detections` = str_replace(`Concurrent Detections`, "\nNA", "")
  ) %>%
  mutate_all(
    cell_spec, format = "html", 
    bold = TRUE, color = text.color
  ) %>%
  kable(escape = FALSE, align = "c") %>%
  kable_styling(fixed_thead = TRUE)
```
</details>

<details>
<summary>Viral Testing Heatmap</summary>

Building from the viral summary table above, this heatmap provides more granular information about sampling effort and detection rates across the five priority PREDICT-2 viral groups: Coronaviruses, Filoviruses, Flaviviruses, Influenzas, and Paramyxoviruses. Data shown within the heatmap represent numbers of viral PCR tests. Host taxa sampled are summarized to the genus-level, and taxa groups are indicated in parentheses. The intensity of red color within the heatmap scales with viral detection rate. Host taxa that never yielded positive viral tests for a given viral group are shown in white, while red coloration indicates increasingly higher rates of viral detection.

```{r heatmap, fig.align = "center", fig.width = 10}

# Plot country-level heat maps of viral detections in specimens

tests.of.interest <- c("Coronaviruses", "Filoviruses", "Flaviviruses",
                       "Influenzas", "Paramyxoviruses")

tmp <- d2 %>%
  mutate(
    family = case_when(
      is.na(family) ~ "Unknown",
      TRUE ~ family
    ),
    genus = case_when(
      is.na(genus) ~ "Unknown",
      TRUE ~ genus
    )
  ) %>%
  filter(
    test_requested %in% tests.of.interest,
    test_type == "Conventional PCR"
  ) %>%
  arrange(gains4_test_id, desc(virus_detected)) %>%
  distinct(gains4_test_id, .keep_all = TRUE) %>%
  group_by(taxa_group_mod, genus, test_requested) %>%
  summarize(
    n_tests = n_distinct(gains4_test_id),
    n_positives = sum(virus_detected, na.rm = TRUE),
    prop = n_positives/n_tests,
    percent = round(n_positives/n_tests*100, digits = 1),
    percent_mod = paste0(percent, "% (", n_tests, ")")
  ) %>%
  ungroup() %>%
  filter(
    !is.na(taxa_group_mod),
    !is.na(test_requested)
  ) %>%
  arrange(taxa_group_mod, genus) %>%
  mutate(
    genus = paste0(genus, " (", taxa_group_mod, ")"),
    genus = factor(genus, rev(unique(genus)))
  )

tmp2 <- distinct(tmp, genus, taxa_group_mod)

horizontal.breaks <- c()

for(i in unique(tmp2$taxa_group_mod)) {
  
  horizontal.breaks <- 
    c(horizontal.breaks, max(which(tmp2$taxa_group_mod == i)))
}

horizontal.breaks <- horizontal.breaks[horizontal.breaks != nrow(tmp2)]
horizontal.breaks <- nrow(tmp2) - horizontal.breaks
horizontal.breaks <- horizontal.breaks + 0.5

tmp %>%
  ggplot(aes(
    x = test_requested, 
    y = genus
  )) +
  xlab("Viral Test Type") +
  scale_x_discrete(position = "top") +
  geom_tile(aes(fill = log(1 + prop)), color = "lightgray") +
  geom_text(aes(label = percent_mod)) +
  geom_hline(yintercept = horizontal.breaks, size = 0.4) +
  scale_fill_gradientn(colors = c("white", "firebrick"), limits = c(0, 0.7)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text.x = element_text(size = 14),
    axis.title.x = element_text(size = 20),
    text = element_text(size = 13),
    axis.title.y = element_blank()
  )
```
</details>

<details>
<summary>Site-Level Summary Table</summary>

This table provides a site-level overview of in-country PREDICT-2 viral surveillance. For each site, the table outlines basic site characteristics as well as the total number of viruses and host taxa sampled from that site. 

```{r tables-2}

get_country_site_viruses2(view = FALSE, animal_virus_summary) %>% 
  mutate_all(
    cell_spec, format = "html", 
    bold = TRUE, color = text.color
  ) %>%
  kable(escape = FALSE, align = "c") %>%
  kable_styling(fixed_thead = TRUE)
```
</details>

```{r viral-curves-prep, include = FALSE}

# Define the viral test types and specific protocols of interest

tests.of.interest <- c("Coronaviruses", "Filoviruses", "Flaviviruses",
                       "Influenzas", "Paramyxoviruses")

protocols.of.interest <- c(
  "Modified Watanabe et al, RdRp gene",
  "Unpublished, UCD",
  "Moureau et al, NS5 gene",
  "Anthony et al, M gene",
  "Tong et al, PAR"
)

# Recover all specimens for which a viral test type of interest was conducted
# using the specified protocol of interest

specimens <- d2 %>%
  filter(
    test_requested %in% tests.of.interest,
    test_requested_protocol %in% protocols.of.interest
  ) %>%
  group_by(specimen_id, test_requested) %>%
  summarize(
    n = n(),
    n_tests = n_distinct(gains4_test_id),
    tests = glue_collapse(unique(test_requested), sep = ","),
    test_protocols = glue_collapse(unique(test_requested_protocol, sep = ","))
  ) %>%
  filter(
    n_tests == 1
  ) %>%
  pull(specimen_id)

# Create a data subset for viral curves plotting that contains only the
# specimens of interest for the viral test types of interest

d.subset <- d2 %>%
  filter(
    test_requested %in% tests.of.interest,
    test_requested_protocol %in% protocols.of.interest,
    specimen_id %in% specimens
  )

assertthat::assert_that(n_distinct(d.subset$specimen_id) == length(unique(specimens)))

# Create iNEXT objects

i.list <- create_ilist(d.subset, "test_requested", "specimen_id")
if(length(i.list) == 1) {x <- as.matrix(i.list[[1]])}
if(length(i.list) > 1) {x <- i.list}
i.out <- iNEXT(x, q = 0, datatype = "incidence_raw")
```

<details>
<summary>Viral Discovery Curves</summary>

To provide model-based estimates of viral sampling completeness within country, here we generate viral discovery curves across the five priority PREDICT-2 viral groups. In order to preserve interpretability among curves, we have restricted the data included in this portion of the report. Specifically, we report only on specimens that were tested for the same viral test protocol within each viral test type. The viral test protocols considered here are: `r glue_collapse(paste0(protocols.of.interest, " (", tests.of.interest, ")"), sep = "; ")`. Thus, every specimen included in figure was tested only once, with the viral test protocol indicated, for each viral test type.

```{r, viral-curves-plot, fig.align = "center", fig.height = 6, fig.width = 8}

if(length(i.list) > 0) {
  
  # Set plot characteristics and plot the iNEXT results
  
  axis.title.size <- 28
  axis.text.size <- 22
  legend.text.size <- 22
  template.colors <- wes_palette("Darjeeling1")[1:5]
  plot.colors <- template.colors[tests.of.interest %in% names(i.list)]
  
  ggiNEXT(i.out) +
    xlab("Number of specimens") + ylab("Viral diversity") +
    scale_color_manual(values = plot.colors, labels = names(i.list)) +
    scale_fill_manual(values = plot.colors, labels = names(i.list)) +
    scale_shape_manual(values = rep(19, length(i.list)), labels = names(i.list)) +
    guides(linetype = F) +
    theme_minimal() +
    theme(axis.title = element_text(size = axis.title.size),
          axis.text = element_text(size = axis.text.size),
          legend.title = element_blank(),
          legend.text = element_text(size = legend.text.size),
          legend.position = "bottom")
}
```
</details>

### Section 2: Current-State-of-Knowledge Risk Maps

```{r get-map-data, include=FALSE}

# Get administrative borders of countries of interest
country_mod <-  mod_country(country) # for density rasters
country_eha <-  mod_country(eidith::eha_countries()) %>% unique() # for range layers

admin <- ne_countries(country = country, type='countries', scale = 'large')
admin_eha <- ne_countries(country = country_eha, type='countries', scale = 'large')

# Centroids for setting view in leaflet
country_centroid <- CoordinateCleaner::countryref %>% 
  filter(name == countrycode(sourcevar = country_mod,
                             origin = "country.name",
                             destination = "country.name")) %>%
  slice(1)

# Viral-species pairs
animal_viral_pairs <- animal_virus_summary %>% 
  select(species_scientific_name, viral_species) %>% 
  distinct()

# Get population density rasters
human_dens <- get_layers("gpw-v4-population-density_2015.tif", admin)
mammal_dens <- get_layers("summed_mammal_livestock.tif", admin)

# Get iucn ranges for species with viral detections
iucn <- st_read(h("data", "TERRESTRIAL_MAMMALS")) %>% # downloaded: https://www.iucnredlist.org/resources/spatial-data-download
  filter(presence == 1) %>%
  mutate(
    binomial = case_when(
      binomial == "Rattus arfakienis" ~ "Rattus arfakiensis",
      str_detect(binomial, "Oryx beisa ssp") ~ "Oryx beisa",
      TRUE ~ as.character(binomial)
    )
  )

iucn <- iucn %>%
  left_join(., read_csv(h("data", "iucn_to_hp3_taxonomic_harmonization.csv")),
            by = c("binomial" = "IUCN_name")) %>%
  mutate(binomial = ifelse(!is.na(hp3_zoo_prediction_name), hp3_zoo_prediction_name, binomial))

iucn_detects <- iucn %>%
  filter(binomial %in% unique(animal_viral_pairs$species_scientific_name))

```

```{r maps}

# set palettes
max_val_human <- ceiling(maxValue(human_dens))
pal_human <- colorBin(palette =
                        c("white","gray50", "black"),
                        #c("azure4", "yellow", "coral2"),
                        #c("mistyrose1", "coral", "darkred"),
                      domain = -1:max_val_human, na.color = "transparent")

max_val_mammal <- ceiling(maxValue(mammal_dens))
min_val_mammal <- floor(minValue(mammal_dens))

pal_mammal <- colorBin( c("white","gray50", "black"),
  #palette = c("azure4", "yellow", "coral2"), 
                       domain = min_val_mammal:max_val_mammal, 
                       na.color = "transparent", pretty = TRUE, 
                       bins = 5)

opac <- 0.3

# leaflet
lf <- leaflet() %>%
  addProviderTiles("CartoDB.DarkMatter") %>%
  addPolygons(data = admin_eha, fill = FALSE, stroke = TRUE, weight = 1, color = "white", opacity = 0.5) %>%
    addPolygons(data = admin, fill = FALSE, stroke = FALSE, group = "None") %>% 
  addFullscreenControl(position = "topright")


for(vir in unique(animal_viral_pairs$viral_species)){

  species <- animal_viral_pairs %>%
    filter(viral_species == vir, species_scientific_name %in% iucn_detects$binomial) %>%
    pull(species_scientific_name)

  if(length(species) < 11){
    pal_spec <- suppressWarnings(brewer.pal(length(species), "Set3"))
    names(pal_spec) <- species

    for(spec in species){

      iucn_sub <- iucn_detects %>% filter(binomial==spec)

      lf <- lf %>%
        addPolygons(data = iucn_sub,
                    stroke = TRUE, color = unname(pal_spec[spec]), weight = 2, opacity = opac,
                    fill = TRUE, fillColor = unname(pal_spec[spec]), fillOpacity = opac,
                    label = spec,
                    group = vir)

    }
  } else { # n species > 10

          iucn_sub <- iucn_detects %>% filter(binomial %in% species)

    lf <- lf %>%
      addPolygons(data = iucn_sub,
                  stroke = TRUE, color = brewer.pal(3, "Accent")[1], weight = 2, opacity = opac,
                  fill = TRUE, fillColor = brewer.pal(3, "Accent")[1], fillOpacity = opac,
                  label = glue("All Species: ", glue_collapse(species, "\n")),
                  group = vir)

  }
}

lf <- lf %>%
  # Human
  addRasterImage(x = human_dens, colors = pal_human, group = "Human", opacity = 1) %>%
  addLegend(pal = pal_human, values = values(human_dens), group = "Human", position = "bottomright",
            title = "Human Population Density" , labFormat = labelFormat(digits = 0 ,transform = function(x) 10 ^ x)) %>%
   # Mammals
  addRasterImage(x = mammal_dens, colors = pal_mammal, opacity = 0.8, group = "Mammal") %>%
  addLegend(pal = pal_mammal, values = values(mammal_dens), group = "Mammal", position = "bottomright",
            title = "Mammal Livestock Density" , labFormat = labelFormat(digits = 0)) %>%
  # User controlled layers
  addLayersControl(
    overlayGroups  = c("Human", "Mammal"), #  legend group only works when using overlayGroups
    baseGroups = c("none", sort(unique(animal_viral_pairs$viral_species))),
    options = layersControlOptions(collapsed = TRUE),
    position = "bottomleft"
  )  %>%
  hideGroup("Mammal") %>%
  setView(zoom = 3, lng = country_centroid$centroid.lon, lat = country_centroid$centroid.lat)

lf

```

### Section 3: Prioritization of Future Viral Discovery and Zoonotic Surveillance

```{r, missing-zoonoses-analysis-prep, include = FALSE}

mz <- read_csv(h("data", "hp3_zoo_predictions.csv")) %>%
  mutate(
    species = case_when(
      species == "Rattus_arfakienis" ~ "Rattus arfakiensis",
      TRUE ~ str_replace(species, "_", " ")
    )
  ) %>%
  mutate_if(is.numeric, round, 2) %>%
  filter(species != "Pteropus pelewensis ssp. yapensis") %>%
  left_join(., read_csv(h("data", "hp3_taxonomy_harmonization.csv")), by = "species") %>%
  mutate(species = 
           ifelse(!is.na(species_alt), 
                  paste0(species, "|", species_alt),
                  species)
  ) %>%
  separate_rows(species, sep = "\\|") %>%
  select(-species_alt) %>%
  arrange(desc(pred_mean))

mammals.in.country <- read_csv(h("data", "mammal_country_lookup.csv")) %>%
  filter(country == params$country) %>%
  pull(binomial)

mz.subset <- filter(mz, species %in% mammals.in.country)

species.sampled.in.country <- d2 %>%
  mutate(
    species_scientific_name = str_replace(species_scientific_name, "cf. ", ""),
    species_scientific_name = word(species_scientific_name, 1, 2)
  ) %>%
  pull(species_scientific_name) %>%
  unique()

text.color <- ifelse(mz.subset$species %in% species.sampled.in.country, "#1B8925", "#BD0505")

specimen.count <- d2 %>%
  mutate(
    species_scientific_name = str_replace(species_scientific_name, "cf. ", ""),
    species_scientific_name = word(species_scientific_name, 1, 2)
  ) %>%
  group_by(species_scientific_name) %>%
  summarize(
    specimen_count = n_distinct(specimen_id, na.rm = T),
    virus_count = n_distinct(viral_species, na.rm = T),
    viruses_detected = ifelse(virus_count > 0, "Yes", "No")
  )

assertthat::assert_that(length(species.sampled.in.country) == nrow(specimen.count))

mz.subset <- left_join(mz.subset, specimen.count, by = c("species" = "species_scientific_name"))
```

<details>
<summary>Sampling Prioritization Based on Missing Zoonoses</summary>

To help prioritize future viral surveillance in-country, we draw on the modeling work of [Olival et al. 2017](https://www.nature.com/articles/nature22975). Using a simplified version of the "missing zoonoses" model from that paper, we have generated a list of host species occurring in-country. These species are ranked according to model-based estimates of the number of predicted unobserved zoonotic viruses remaining in that host. Further, species are color-coded according to PREDICT-2 sampling history. Host species already sampled in-country for PREDICT-2 are indicated in green, along with the number of specimens collected from that species. Host species not sampled in PREDICT-2, and therefore of possible interest for future viral surveillance work, are highlighted in red.

```{r, missing-zoonoses-analysis}

mz.subset %>% 
  select(1, 2, 9, 11) %>%
  mutate(
    specimen_count = ifelse(is.na(specimen_count), 0, specimen_count),
    viruses_detected = ifelse(is.na(viruses_detected), "", viruses_detected)) %>%
  mutate_at(
    vars(species),
    cell_spec, format = "html", 
    bold = TRUE, color = text.color
  ) %>%
  mutate_at(
    vars(-species),
    cell_spec, format = "html", 
    bold = TRUE, color = "#787272"
  ) %>%
  rename(
    `Host Species` = species,
    `Predicted Missing Zoonoses` = pred_mean,
    `Number of Specimens Collected` = specimen_count,
    `Viruses Detected In-Country?` = viruses_detected
  ) %>%
  kable(escape = FALSE, align = "c") %>%
  kable_styling(fixed_thead = TRUE)
```
</details>
