---
params:
  country: "Thailand"
title: 'PREDICT M&A Report: `r params$country`'
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: false
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
h <- here::here
walk(list.files(h("R/"), full.names = TRUE),
     source, echo = FALSE, verbose = FALSE)
country <- params$country
```

![](./media/predict-logos.png){width="100%"}

#### _Click on the_ ▶ _︎arrows to expand sections._

```{r read-data}

library(eidith)

# Load EIDITH data tables

e <- ed_events() %>% 
  filter(country == !!country)
a <- ed_animals()
s <- ed_specimens()
t <- ed_tests()
v <- ed_viruses()
ts <- ed_testspecimen()

e2 <- ed2_events() %>%
  filter(country == !!country)
a2 <- ed2_animals() %>% 
  select(-c(integer_id, gains4_event_id, gains4_sample_unit_id)) %>%
  mutate(class = stringr::str_to_sentence(class))
s2 <- ed2_specimens() %>% 
  arrange(desc(integer_id)) %>%
  distinct(specimen_id, .keep_all = TRUE) %>%
  select(-c(integer_id, gains4_sample_unit_id, gains4_specimen_id))
t2 <- ed2_tests() %>%
  select(-c(integer_id, gains4_specimen_id)) %>%
  mutate(
    virus = case_when(
      virus == "" ~ NA_character_,
      TRUE ~ virus
    )
  )
ti <- ed2_test_interpreted() %>%
  select(-c(integer_id))

# Split out P2 viral co-infection data

t2 <- t2 %>%
  mutate(
    sequence = case_when(
      str_detect(sequence, "\\|") & !(str_detect(virus, "\\|")) ~ 
        str_replace(sequence, "\\|", ";"),
      TRUE ~ sequence
    )
  )

t2 <- separate_rows(t2, virus, sequence, sep = "\\|")

# Synonymize viral names

v <- v %>%
  mutate(viral_species = stringi::stri_replace_first_regex(
    virus_name, "(new\\s)?strain\\sof\\s", ""))

t2 <- t2 %>%
  mutate(viral_species = stringi::stri_replace_first_regex(
    virus, "(new\\s)?strain\\sof\\s", ""))

# Join across all tables to get complete data tables

d <- left_join(e, a, by = "event_id") %>%
  left_join(s, by = "animal_id") %>%
  left_join(ts, by = "specimen_id") %>%
  left_join(t, by = "test_id") %>%
  left_join(v, by = "test_id")

d2 <- full_join(e2, a2, by = c("event_name", "project")) %>%
  left_join(s2, by = c("animal_id" = "animal_human_id", "project")) %>%
  left_join(t2, by = c("specimen_id", "project"))
```
