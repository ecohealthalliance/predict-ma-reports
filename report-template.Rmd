---
params:
  country: "Thailand"
title: 'PREDICT M&A Report: `r params$country`'
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: false
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(leaflet)
library(raster)
library(maptools)
library(DT)
library(eidith)
library(glue)
library(iNEXT)
library(kableExtra)
library(tidyverse)
library(wesanderson)
h <- here::here
walk(list.files(h("R/"), full.names = TRUE),
     source, echo = FALSE, verbose = FALSE)
country <- params$country
```

![](./media/predict-logos.png){width="100%"}

#### _Click on the_ ▶ _︎arrows to expand sections._

```{r read-data, include = FALSE}

# Load EIDITH data tables

e <- ed_events() %>% 
  filter(country == !!params$country) # events filtered to country
a <- ed_animals()
s <- ed_specimens()
t <- ed_tests()
v <- ed_viruses()
ts <- ed_testspecimen()

e2 <- ed2_events() %>%
  filter(country == !!params$country) %>% # events filtered to country
  arrange(desc(integer_id)) %>%
  distinct(event_name, .keep_all = TRUE)
a2 <- ed2_animals() %>% 
  dplyr::select(-c(integer_id, gains4_event_id, gains4_sample_unit_id))
s2 <- ed2_specimens() %>% 
  dplyr::select(-c(integer_id, gains4_sample_unit_id))
t2 <- ed2_tests() %>%
  dplyr::select(-c(integer_id))
ti <- ed2_test_interpreted() %>%
  arrange(desc(integer_id)) %>%
  distinct(gains4_test_id, .keep_all = TRUE) %>%
  dplyr::select(
    -c(integer_id, is_outbreak_testing, season,
       lab_name, real_time_positive_control_value_1, real_time_positive_control_value_2,
       real_time_internal_control_value, real_time_ct_value, lab_name_confirmation,
       test_status, date_govt_approved_release)
  )

# Modify animal taxonomy information

a2 <- a2 %>%
  mutate(
    class = stringr::str_to_sentence(class),
    order = stringr::str_to_sentence(order),
    family = stringr::str_to_sentence(family),
    taxa_group_mod = case_when(
      taxa_group == "cats" ~ "carnivores",
      taxa_group == "dogs" ~ "carnivores",
      taxa_group == "poultry/other fowl" ~ "birds",
      family == "Sciuridae" ~ "rodents/shrews",
      TRUE ~ taxa_group
    ),
    species_scientific_name = case_when(
      species_scientific_name == "Syncerus Caffer" ~ "Syncerus caffer",
      TRUE ~ species_scientific_name
    )
  )

# Split out P2 viral co-infection data

t2 <- t2 %>%
  mutate(
    sequence = case_when(
      str_detect(sequence, "\\|") & !(str_detect(virus, "\\|")) ~ 
        str_replace(sequence, "\\|", ";"),
      str_detect(sequence, "\\|") & is.na(virus) ~ 
        str_replace(sequence, "\\|", ";"),
      TRUE ~ sequence
    )
  )

t2 <- separate_rows(t2, virus, sequence, sep = "\\|")

# Modify virus name (in new "viral_species" column) and detection data

v <- v %>%
  mutate(viral_species = stringi::stri_replace_first_regex(
    virus_name, "(new\\s)?strain\\sof\\s", ""))

t2 <- t2 %>%
  mutate(
    virus = case_when(
      virus == "" ~ NA_character_,
      TRUE ~ virus
    ),
    viral_species = stringi::stri_replace_first_regex(virus, "(new\\s)?strain\\sof\\s", ""),
    viral_species = ifelse(str_detect(viral_species, "(OC43)"), "Betacoronavirus 1 (OC43)", viral_species),
    viral_species = ifelse(str_detect(viral_species, "MJ/67C"), "Hipposideros bat alphacoronavirus MJ/67C", viral_species),
    viral_species = str_replace(viral_species, "Bat Coronavirus", "Bat coronavirus"),
    viral_species = str_replace(viral_species, " Bat ", " bat "),
    virus_detected = ifelse(confirmation_result == "Positive", 1, 0)
  ) %>%
  left_join(., read_csv(h("data", "viral_species_modifications.csv")), by = "viral_species") %>%
  mutate(viral_species = ifelse(!is.na(viral_species_mod), viral_species_mod, viral_species)) %>%
  dplyr::select(-viral_species_mod)

# Join across all tables to get complete data

d <- left_join(e, a, by = "event_id") %>%
  left_join(s, by = "animal_id") %>%
  left_join(ts, by = "specimen_id") %>%
  left_join(t, by = "test_id") %>%
  left_join(v, by = "test_id")

d2 <- left_join(e2, a2, by = c("event_name", "project")) %>%
  left_join(s2, by = c("animal_id" = "animal_human_id", "project")) %>%
  left_join(t2, by = c("specimen_id", "gains4_specimen_id", "project")) %>%
  left_join(ti, by = c("gains4_specimen_id", "gains4_test_id", "project"))
```

### Section 2: Current-State-of-Knowledge Risk Maps
```{r get-map-data, include=FALSE}
# library(sf)
# library(GADMTools)

# Get site locations
sites <- e2 %>% 
  dplyr::select(country, site_latitude, site_longitude, concurrent_sampling_site) %>% 
  mutate_at(vars(site_latitude, site_longitude), ~as.numeric(.)) %>%
  distinct()

# Get administrative borders of countries of interest
match <- c("\\-.*", "^DR", "PDR", "Myanmar")
replace <- c("", "Democratic Republic of the", "People's Democratic Republic", "Burma")

country_wrld <-  str_replace_all(country,
                                 c("\\-.*" = "", 
                                   "^DR" = "Democratic Republic of the",
                                   "PDR" = "People's Democratic Republic",
                                   "Myanmar" = "Burma",
                                   "Vietnam" = "Viet Nam",
                                   "Tanzania" = "United Republic of Tanzania"
                                 ))

data("wrld_simpl")
admin <- wrld_simpl[wrld_simpl@data$NAME %in% country_wrld, ] 

# human population density
human_dens <- raster(h("map-layers/gpw-v4-population-density_2015.tif")) %>%
  crop(., admin) %>%
  mask(., admin)

values(human_dens)[values(human_dens)==0] <- 1
values(human_dens) <- log10(values(human_dens))
```

```{r human-dens-map}
pal <- colorNumeric(c("azure4", "yellow", "coral2"), values(human_dens),
                    na.color = "transparent")

leaflet() %>% 
  # Base
  addProviderTiles("CartoDB.Positron", group = "Base") %>%
  #Overlay
  addRasterImage(x = human_dens, colors = pal, opacity = 0.8, group = "Human") %>%
  #Legend
  addLegend(pal = pal, values = values(human_dens), group = "Human", position = "bottomright",
            title = "Human Population Density" , labFormat = labelFormat(digits = 0 ,transform = function(x) 10 ^ x)) %>%
  addLayersControl(
    overlayGroups = c("Human"),
    options = layersControlOptions(collapsed = FALSE),
    position = "bottomleft"
  ) 
  
```

