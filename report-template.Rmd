---
params:
  country: "Thailand"
title: 'PREDICT M&A Report: `r params$country`'
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: false
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(DT)
library(eidith)
library(glue)
library(iNEXT)
library(kableExtra)
library(tidyverse)
library(wesanderson)
h <- here::here
walk(list.files(h("R/"), full.names = TRUE),
     source, echo = FALSE, verbose = FALSE)
country <- params$country
```

![](./media/predict-logos.png){width="100%"}

#### _Click on the_ ▶ _︎arrows to expand sections._

```{r read-data}

# Load EIDITH data tables

e <- ed_events() %>% 
  filter(country == !!country)
a <- ed_animals()
s <- ed_specimens()
t <- ed_tests()
v <- ed_viruses()
ts <- ed_testspecimen()

e2 <- ed2_events() %>%
  filter(country == !!country)
a2 <- ed2_animals() %>% 
  select(-c(integer_id, gains4_event_id, gains4_sample_unit_id)) %>%
  mutate(class = stringr::str_to_sentence(class))
s2 <- ed2_specimens() %>% 
  arrange(desc(integer_id)) %>%
  distinct(specimen_id, .keep_all = TRUE) %>%
  select(-c(integer_id, gains4_sample_unit_id, gains4_specimen_id))
t2 <- ed2_tests() %>%
  select(-c(integer_id, gains4_specimen_id)) %>%
  mutate(
    virus = case_when(
      virus == "" ~ NA_character_,
      TRUE ~ virus
    )
  )
ti <- ed2_test_interpreted() %>%
  select(-c(integer_id))

# Modify animal taxonomy information

a2 <- a2 %>%
  mutate(
    family = stringr::str_to_sentence(family),
    taxa_group = case_when(
      family == "Sciuridae" ~ "rodents/shrews",
      TRUE ~ taxa_group
    )
  )

# Split out P2 viral co-infection data

t2 <- t2 %>%
  mutate(
    sequence = case_when(
      str_detect(sequence, "\\|") & !(str_detect(virus, "\\|")) ~ 
        str_replace(sequence, "\\|", ";"),
      TRUE ~ sequence
    )
  )

t2 <- separate_rows(t2, virus, sequence, sep = "\\|")

# Modify virus name and detection data

v <- v %>%
  mutate(viral_species = stringi::stri_replace_first_regex(
    virus_name, "(new\\s)?strain\\sof\\s", ""))

t2 <- t2 %>%
  mutate(
    viral_species = stringi::stri_replace_first_regex(virus, "(new\\s)?strain\\sof\\s", ""),
    viral_species = str_replace(viral_species, "Alpha coronavirus", "Alphacoronavirus"),
    viral_species = str_replace(viral_species, "bat coronavirus", "Bat coronavirus"),
    viral_species = str_replace(viral_species, "Bat Coronavirus", "Bat coronavirus")
  ) %>%
  mutate(virus_detected = ifelse(confirmation_result == "Positive", 1, 0))

# Join across all tables to get complete data

d <- left_join(e, a, by = "event_id") %>%
  left_join(s, by = "animal_id") %>%
  left_join(ts, by = "specimen_id") %>%
  left_join(t, by = "test_id") %>%
  left_join(v, by = "test_id")

d2 <- left_join(e2, a2, by = c("event_name", "project")) %>%
  left_join(s2, by = c("animal_id" = "animal_human_id", "project")) %>%
  left_join(t2, by = c("specimen_id", "project"))
```

<details>
<summary>Summary Tables</summary>
``` {r tables}

animal.grouping.vars <-
  c("country", "concurrent_sampling_site", "site_name",
    "human_density_impact", "taxa_group", "species_scientific_name", "viral_species")

animal_virus_summary <- d2 %>%
  filter(!is.na(viral_species)) %>%
  group_by_at(vars(one_of(animal.grouping.vars))) %>%
  summarize(n_positives = sum(virus_detected)) %>%
  ungroup() %>%
  arrange(country, site_name, taxa_group, species_scientific_name, viral_species, n_positives)

get_country_site_viruses2() %>% 
  kable(format = "html", escape = FALSE) %>%
  kable_styling()
```
</details>

<details>
<summary>Viral Testing Heatmap</summary>
``` {r heatmap}

# Plot country-level heat maps of viral detections in specimens

tests.of.interest <- c("Coronaviruses", "Filoviruses", "Flaviviruses",
                       "Influenzas", "Paramyxoviruses")
taxa.of.interest <- c("bats", "birds", "non-human primates", "rodents/shrews")

tmp <- d2 %>%
  mutate(
    family = case_when(
      is.na(family) ~ "Unknown",
      TRUE ~ family
    ),
    genus = case_when(
      is.na(genus) ~ "Unknown",
      TRUE ~ genus
    )
  ) %>%
  filter(
    test_requested %in% tests.of.interest,
    taxa_group %in% taxa.of.interest
  ) %>%
  arrange(gains4_test_id, desc(virus_detected)) %>%
  distinct(gains4_test_id, .keep_all = TRUE) %>%
  group_by(taxa_group, genus, test_requested) %>%
  summarize(
    n_tests = n_distinct(gains4_test_id),
    n_positives = sum(virus_detected, na.rm = TRUE),
    prop = n_positives/n_tests,
    percent = round(n_positives/n_tests*100, digits = 1),
    percent_mod = paste0(percent, "% (", n_tests, ")")
  ) %>%
  ungroup() %>%
  filter(
    !is.na(taxa_group),
    !is.na(test_requested)
  ) %>%
  arrange(taxa_group, genus) %>%
  mutate(genus = factor(genus, rev(unique(genus))))

tmp2 <- distinct(tmp, genus, taxa_group)

horizontal.breaks <- c()

for(i in unique(tmp2$taxa_group)) {
  
  horizontal.breaks <- 
    c(horizontal.breaks, max(which(tmp2$taxa_group == i)))
}

horizontal.breaks <- horizontal.breaks[horizontal.breaks != nrow(tmp2)]
horizontal.breaks <- nrow(tmp2) - horizontal.breaks
horizontal.breaks <- horizontal.breaks + 0.5

tmp %>%
  ggplot(aes(
    x = test_requested, 
    y = genus
  )) +
  xlab("Viral Test Type") +
  scale_x_discrete(position = "top") +
  geom_tile(aes(fill = log(1 + prop)), color = "lightgray") +
  geom_text(aes(label = percent_mod)) +
  geom_hline(yintercept = horizontal.breaks, size = 0.4) +
  scale_fill_gradientn(colors = c("white", "firebrick"), limits = c(0, 0.7)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text.x = element_text(size = 14),
    axis.title.x = element_text(size = 20),
    text = element_text(size = 13),
    axis.title.y = element_blank()
  )
```
</details>

```{r viral-curves-prep, include = FALSE}

# Define the viral test types and specific protocols of interest

tests.of.interest <- c("Coronaviruses", "Filoviruses", "Flaviviruses",
                       "Influenzas", "Paramyxoviruses")
protocols.of.interest <- c(
  "Modified Watanabe et al, RdRp gene",
  "Unpublished, UCD",
  "Moureau et al, NS5 gene",
  "Anthony et al, M gene",
  "Tong et al, PAR"
)

# Recover all specimens for which a viral test type of interest was conducted
# using the specified protocol of interest

specimens <- d2 %>%
  filter(
    test_requested %in% tests.of.interest,
    test_requested_protocol %in% protocols.of.interest
  ) %>%
  group_by(specimen_id, test_requested) %>%
  summarize(
    n = n(),
    n_tests = n_distinct(gains4_test_id),
    tests = glue_collapse(unique(test_requested), sep = ","),
    test_protocols = glue_collapse(unique(test_requested_protocol, sep = ","))
  ) %>%
  filter(
    n_tests == 1
  ) %>%
  pull(specimen_id)

# Create a data subset for viral curves plotting that contains only the
# specimens of interest for the viral test types of interest

d.subset <- d2 %>%
  filter(
    test_requested %in% tests.of.interest,
    test_requested_protocol %in% protocols.of.interest,
    specimen_id %in% specimens
  )

assertthat::assert_that(n_distinct(d.subset$specimen_id) == length(unique(specimens)))

# Create iNEXT objects

i.list <- create_ilist(d.subset, "test_requested", "specimen_id")
i.out <- iNEXT(i.list, q = 0, datatype = "incidence_raw")
```

<details>
<summary>Viral Curves Plot</summary>
``` {r, viral-curves-plot}

# Set plot characteristics and plot the iNEXT results

axis.title.size <- 28
axis.text.size <- 22
legend.text.size <- 22
template.colors <- wes_palette("Darjeeling1")[1:5]
plot.colors <- template.colors[tests.of.interest %in% unique(i.out$AsyEst$Site)]

ggiNEXT(i.out) +
  scale_color_manual(values = plot.colors) +
  scale_fill_manual(values = plot.colors) +
  xlab("Number of specimens") + ylab("Viral diversity") +
  scale_shape_manual(values = rep(19, length(i.list))) +
  guides(linetype = F) +
  theme_minimal() +
  theme(axis.title = element_text(size = axis.title.size),
        axis.text = element_text(size = axis.text.size),
        legend.title = element_blank(),
        legend.text = element_text(size = legend.text.size),
        legend.position = "bottom")
```
</details>
