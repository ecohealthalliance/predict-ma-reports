---
params:
  country:   "Thailand"
title: 'EcoHealth Alliance PREDICT M&A Report: `r params$country`'
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# Load packages
library(CoordinateCleaner)
library(countrycode)
library(cowplot)
library(DT)
library(eidith)
library(glue)
library(iNEXT)
library(kableExtra)
library(leaflet)
library(leaflet.extras)
library(raster)
library(RColorBrewer)
library(rnaturalearth)
library(rnaturalearthdata)
library(sf)
library(tidyverse)

h <- here::here
walk(list.files(h("R/"), full.names = TRUE), source, echo = FALSE, verbose = FALSE)

# Create a variable defining the country for the report
report_country <- params$country
```

<script>
$(function () {
$('[data-toggle="tooltip"]').tooltip()
})
</script>

![](./media/predict-logos.png){width="100%"}

```{r read-data, include = FALSE}
eidith <- read_rds(h("data", "eidith.rds"))

d2 <- read_rds(h("data", "animal.rds"))
d2_country <- d2 %>% 
  filter(country == !!report_country) %>%  # events filtered to country
  as_tibble()
```

```{r viral-species, include = FALSE}

animal_virus_summary <- d2_country %>%
  filter(!is.na(viral_species)) %>%
  group_by(viral_species) %>%
  count() %>%
  ungroup() %>% 
  arrange(-n) %>% 
  filter(n>=30)
```

```{r lasso-prep, include = FALSE}

d2_lasso <- d2_country %>% 
  select(specimen_id, scientific_name, concurrent_sampling_site, age_class, sex, specimen_type, test_requested_protocol, viral_species) %>% 
   drop_na(scientific_name, test_requested_protocol) 

virus_test_type <- d2_lasso %>% 
  distinct(viral_species, test_requested_protocol) %>% 
  arrange(test_requested_protocol) %>% 
  filter(viral_species %in% animal_virus_summary$viral_species)

d2_detects <- d2_lasso %>% 
  drop_na(viral_species) %>% 
  mutate(virus_detected = TRUE)

janitor::get_dupes(d2_detects, specimen_id, test_requested_protocol)
#Can we assume if a sample is positive for one cov, it's negative for others??

d2_lasso <- d2_lasso %>%
  select(-viral_species) %>% 
  distinct() %>% 
  inner_join(virus_test_type, by = "test_requested_protocol") %>% # all test - virus combos
  left_join(d2_detects) %>%  # get detects
  mutate(virus_detected = replace_na(virus_detected, FALSE))

lasso_check <- d2_lasso %>% 
  group_by(viral_species) %>%
  summarize(n = sum(virus_detected)) %>%
  ungroup() %>% 
  arrange(-n) 

assertthat::assert_that(identical(lasso_check, animal_virus_summary))

  # ed2_expand_wide(scientific_name) %>% 
  #   ed2_expand_wide(concurrent_sampling_site) %>% 
  #   ed2_expand_wide(age_class) %>% 
  #     ed2_expand_wide(sex) %>% 
  #   ed2_expand_wide(specimen_type) %>% 
  #   ed2_expand_wide(test_requested_protocol) 

```

