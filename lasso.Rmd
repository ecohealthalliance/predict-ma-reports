---
params:
  country:   "Thailand"
title: 'EcoHealth Alliance PREDICT M&A Report: `r params$country`'
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

# Load packages
library(eidith)
library(ehalasso)
library(tidyverse)
library(recipes)
library(themis)
library(ggthemes)
library(tidymodels)
library(parsnip)
library(tune)
library(rsample)

h <- here::here
walk(list.files(h("R/"), full.names = TRUE), source, echo = FALSE, verbose = FALSE)

# Create a variable defining the country for the report
report_country <- params$country
```

<script>
$(function () {
$('[data-toggle="tooltip"]').tooltip()
})
</script>

![](./media/predict-logos.png){width="100%"}

```{r read-data}

eidith <- read_rds(h("data", "eidith.rds"))

d2 <- read_rds(h("data", "animal.rds"))
d2_country <- d2 %>% 
  filter(country == !!report_country) %>%  # events filtered to country
  as_tibble()

```

```{r viral-species}

animal_virus_summary <- d2_country %>%
  filter(!is.na(viral_species)) %>%
  group_by(viral_species) %>%
  summarize(n = n_distinct(specimen_id)) %>% 
  ungroup() %>% 
  filter(n>=30)

viral_species_include <- animal_virus_summary$viral_species

```

```{r lasso-prep}

lasso_dat_split <- map(viral_species_include, function(virus){
  
  # which specimen had detects
  viral_detects <- d2_country %>% 
    filter(viral_species == !!virus) %>% 
    distinct(specimen_id, scientific_name, test_requested_protocol) 
  
  viral_detects %>% 
    group_by(scientific_name) %>% count
  
  d2_lasso <- d2_country %>% 
    filter(scientific_name %in% unique(viral_detects$scientific_name), # relevant species
           test_requested_protocol %in% unique(viral_detects$test_requested_protocol)) %>%  # relevant lab tests
    distinct(specimen_id, scientific_name, concurrent_sampling_site, age_class, sex, specimen_type) %>% 
    mutate(!!virus := specimen_id %in% unique(viral_detects$specimen_id)) %>% 
    ed2_expand_wide(scientific_name, clean_names = FALSE) %>%
    ed2_expand_wide(concurrent_sampling_site, clean_names = FALSE) %>%
    ed2_expand_wide(age_class, clean_names = FALSE) %>%
    ed2_expand_wide(sex, clean_names = FALSE) %>%
    ed2_expand_wide(specimen_type, clean_names = FALSE) %>% 
    select(-scientific_name, -concurrent_sampling_site, -age_class, -sex, -specimen_type, -specimen_id) 
  
  names(d2_lasso) <- str_remove(names(d2_lasso), "scientific_name_|concurrent_sampling_site_")
  
  d2_lasso %>% 
    summarise_at(vars(!!virus), ~sum(., na.rm = T))  %>% 
    pull(1) %>% 
    assertthat::are_equal(., animal_virus_summary$n[animal_virus_summary$viral_species == virus])
  
  return(d2_lasso)
}) %>% 
  set_names(viral_species_include)

prevalence <- imap(lasso_dat_split, ~sum(pull(.x, !!.y))/nrow(.x))

```

```{r lasso-fit}
library(caret)
map(viral_species_include, function(virus){
  
  # Make model matrix with interactions
  matrices <-  lasso_dat_split[[virus]] %>% 
    make_matrix(., outcome_var = virus,  interactions = TRUE)
  
  # Remove colinear columns prior to running the model
  model_matrix <- remove_colinear_columns(matrices$model_matrix)
  
  # Final data processing before modelling 
  model_tibble <- model_matrix$intermediate_matrix %>% 
    as_tibble() %>% 
    mutate(outcome_var = matrices$outcome_matrix[,virus]) %>% 
    janitor::clean_names() %>% 
    mutate_all(~as.integer(.)) %>% 
    mutate(outcome_var = ifelse(outcome_var==1, "detect", "nondetect"))
  
  # Test/train split
  # train_test_split <- initial_split(model_tibble, strata = "outcome_var")
  # train <- training(train_test_split)
  # test <- testing(train_test_split)
  
  # Define formula + recipe
  model_recipe <- recipe(outcome_var ~ ., data = model_tibble) %>% 
    step_smote(outcome_var) 
  
  cctrl1 <- trainControl(method = "cv", number = 10, returnResamp = "all",
                       classProbs = TRUE, summaryFunction = twoClassSummary)
  
  test_class_rec <- train(x = model_recipe,
                        data = model_tibble,
                        method = "glmnet", 
                        family = "binomial",
                        type.measure = "deviance", 
                        standardize = FALSE,
                        trControl = cctrl1,
                        metric = "ROC",
                        tuneGrid = expand.grid(alpha = seq(.05, 1, length = 15),
                                               lambda = c((1:5)/10)))

  ### ^ uhh did this work? - read SO question about this approach. 
  ###   also, understand caret versus parsnip. could this have been done with parsnip?
  ###   could it be done with tune?
  
  
  # old method
    lambda.fit <- glmnet::cv.glmnet(x =  model_matrix$intermediate_matrix,
                                  y = matrices$outcome_matrix ,
                                  nfolds = 20, #5-fold CV
                                  family = 'binomial',
                                  type.measure = "deviance",
                                  alpha = 1,
                                  standardize = FALSE)
  
  lambda.fit$lambda.min
  
  

  
  # Parsnip Define model
  lasso_mod <- linear_reg() %>% 
    set_engine("glmnet", family = "binomial", type.measure = "deviance", standardize = FALSE)
  
  # Create CV splits
  cv_splits <- vfold_cv(model_tibble, v = 10, strata = "outcome_var")
  
  # tune
  ames_res <- tune_grid(model_recipe, model = lasso_mod, resamples = cv_splits)
  
  # eha function approach:
  
  lasso_fit <- fit_lasso_model(model_matrix$intermediate_matrix,
                               matrices$outcome_matrix)
  
  write_rds(lasso_fit, h("lassos", paste0(report_country, "_", virus, ".rds")))
})
```

```{r plots}

walk(viral_species_include, function(virus){
  
  lasso_fit <- read_rds(h("lassos", paste0(report_country, "_", virus, ".rds")))
  support <- attr(lasso_fit, "bootstrap_support")
  
  coefs <- coef(lasso_fit) %>%
    as.matrix() %>%
    as.data.frame() %>%
    rownames_to_column(var = "variable") %>%
    rename(effect=s0) %>%
    filter(effect != 0) %>%
    filter(stringi::stri_detect_fixed(variable, "Intercept", negate=TRUE)) %>% 
    mutate(support = support[variable]) %>% 
    filter(support >= 0.8) %>% 
    mutate(variable = str_replace_all(variable, "_", " ")) %>% 
    mutate(variable = paste0(variable, " (s = ", round(support, 2), ")")) %>% 
    arrange(desc(effect)) %>%
    mutate(variable = fct_reorder(variable, effect)) %>%
    mutate(pred = plogis(lasso_fit$a0 + effect),
           positive = effect > 0)
  
  ggplot(coefs, aes(x = variable, y = effect, fill=positive)) +
    geom_hline(yintercept = 0, lty=2, lwd=1, color = "gray50") +
    geom_point(pch = 21, stroke = 0.75, size = 4) +
    annotate("segment", x = nrow(coefs), xend = nrow(coefs), y = 0.1*max(coefs$effect), yend = 0.3 * max(coefs$effect), arrow = arrow(length = unit(0.1, "inches"))) +
    annotate("segment", x = nrow(coefs), xend = nrow(coefs), y = -0.1*max(coefs$effect), yend = -0.3 * max(coefs$effect), arrow = arrow(length = unit(0.1, "inches"))) +
    annotate("text", label = "positive association", x = nrow(coefs), y = 0.35 * max(coefs$effect), hjust = 0) +
    scale_fill_manual(values = c(`FALSE` = "#7E03A8FF", `TRUE` = "#F89441FF")) +
    coord_flip() +
    labs(x = "", y = "", title = str_replace(virus, "_", " ")) +
    theme_minimal() +
    theme(legend.position = "none", 
          panel.grid = element_blank(),
          axis.ticks = element_blank(),
          axis.text.x = element_blank(),
          axis.text.y = element_text(size =12),
          axis.line.y.left = element_line(),
          axis.line.x.bottom =  element_line()
    ) 
  
  ggsave(h("lassos", "plots", paste0(report_country, "_", virus, ".png")), width = 12)
})

```

